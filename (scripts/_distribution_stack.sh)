#!/bin/bash
set -e

echo "üì¢ UPGRADING DISTRIBUTION STACK..."
echo "   - Adding: MailChimp, Wix, Ayrshare"
echo "   - Preserving: Notion, Aya, WordPress, Jira"

# 1. INSTALL MARKETING DRIVERS
# mailchimp-marketing: Official SDK
# requests: For Wix/Ayrshare REST APIs
pip install mailchimp-marketing requests --upgrade --quiet

# 2. CREATE THE MARKETING TOOLKIT
# This file wraps the APIs for MailChimp, Wix, and Ayrshare.

mkdir -p vaal-ai-empire/src/tools

cat << 'EOF' > vaal-ai-empire/src/tools/marketing_suite.py
import os
import logging
import requests
import json
import mailchimp_marketing as MailchimpMarketing
from mailchimp_marketing.api_client import ApiClientError

logger = logging.getLogger("MarketingSuite")

class AyrshareTool:
    def __init__(self):
        self.api_key = os.getenv("ARYSHARE_API_KEY")
        self.url = "https://app.ayrshare.com/api/post"

    def post_to_socials(self, text, image_url=None):
        if not self.api_key: return "Ayrshare Offline"
        
        logger.info("üó£Ô∏è AYRSHARE: Broadcasting to Social Media...")
        payload = {
            "post": text,
            "platforms": ["twitter", "linkedin", "facebook"],
            "mediaUrls": [image_url] if image_url else []
        }
        headers = {'Authorization': f'Bearer {self.api_key}'}
        
        try:
            r = requests.post(self.url, json=payload, headers=headers)
            if r.status_code == 200:
                return "Socials Posted"
            return f"Social Error: {r.text}"
        except Exception as e:
            return f"Ayrshare Failed: {e}"

class WixTool:
    def __init__(self):
        # Requires Account ID and Site ID along with Key
        self.api_key = os.getenv("MANAGE_WIX_API_KEY")
        self.site_id = os.getenv("WIX_SITE_ID")
        self.account_id = os.getenv("WIX_ACCOUNT_ID")
    
    def create_blog_post(self, title, content):
        if not self.api_key or not self.site_id: return "Wix Config Missing"
        
        logger.info(f"üåê WIX: Posting '{title}'...")
        # Using Wix Data API / Blog API endpoint structure
        url = "https://www.wixapis.com/blog/v3/posts"
        
        headers = {
            "Authorization": self.api_key,
            "wix-site-id": self.site_id,
            "wix-account-id": self.account_id,
            "Content-Type": "application/json"
        }
        
        payload = {
            "post": {
                "title": title,
                "richContent": {"nodes": [{"type": "PARAGRAPH", "nodes": [{"type": "TEXT", "textData": {"text": content}}]}]}
            }
        }
        
        try:
            r = requests.post(url, json=payload, headers=headers)
            if r.status_code == 200:
                return "Wix Published"
            return f"Wix Error: {r.text}"
        except Exception as e:
            return f"Wix Connection Failed: {e}"

class MailChimpTool:
    def __init__(self):
        self.api_key = os.getenv("MAILCHIMP_API_KEY")
        self.server = os.getenv("MAILCHIMP_SERVER_PREFIX", "us6") # e.g. us1, us6
        
        self.client = None
        if self.api_key:
            self.client = MailchimpMarketing.Client()
            self.client.set_config({"api_key": self.api_key, "server": self.server})

    def send_campaign(self, subject, body_text):
        if not self.client: return "MailChimp Offline"
        
        logger.info(f"üìß MAILCHIMP: Preparing Campaign '{subject}'...")
        try:
            # 1. Create Campaign
            campaign = self.client.campaigns.create({"type": "regular", "recipients": {"list_id": "YOUR_LIST_ID"}, "settings": {"subject_line": subject, "title": subject, "from_name": "Vaal Empire", "reply_to": "info@vaal.ai"}})
            cid = campaign['id']
            
            # 2. Set Content
            self.client.campaigns.set_content(cid, {"plain_text": body_text, "html": f"<p>{body_text}</p>"})
            
            # 3. Send
            self.client.campaigns.send(cid)
            return "Newsletter Sent"
        except ApiClientError as error:
            return f"MailChimp Error: {error.text}"
        except Exception as e:
            return f"MailChimp Failed: {e}"
EOF

# 3. UPDATE THE MASTER PIPELINE SCRIPT
# This integrates everything into one flow.

cat << 'EOF' > vaal-ai-empire/scripts/run_authority_pipeline.py
import os
import sys
import logging

# Setup Path
sys.path.append(os.getcwd())

# Imports
try:
    from notion_client import Client as NotionClient
    from jira import JIRA
    from src.core.empire_supervisor import EmpireSupervisor
    from src.core.model_router import DepartmentRouter # Aya
    from src.tools.wordpress_publisher import WordPressTool
    from src.tools.marketing_suite import AyrshareTool, WixTool, MailChimpTool
except ImportError as e:
    print(f"‚ùå Dependency Error: {e}")
    sys.exit(1)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("OmnichannelPipeline")

def run():
    # --- CONFIG ---
    NOTION_PAGE_ID = os.getenv("NOTION_PAGE_ID", "2b8af2b8d06b8150a5acfe7aa7d8f221")
    JIRA_URL = "https://dimakatsomoleli.atlassian.net"
    
    # 1. SOURCE: NOTION
    logger.info("üì• STEP 1: Fetching Notion Content...")
    notion_key = os.getenv("NOTION_API_KEY")
    if not notion_key: return
    
    notion = NotionClient(auth=notion_key)
    try:
        blocks = notion.blocks.children.list(block_id=NOTION_PAGE_ID)
        raw_text = " ".join([b[b['type']]['text'][0]['plain_text'] for b in blocks['results'] if b['type'] == 'paragraph' and b['paragraph']['text']])
    except:
        raw_text = "AI revolutionizing South African Industries."

    # 2. VISION: AYA
    logger.info("üëÅÔ∏è STEP 2: Aya Visualizing...")
    router = DepartmentRouter()
    visual_desc = router.delegate_to_vision(f"Create an image prompt for: {raw_text[:50]}")
    
    # 3. BRAIN: QWEN
    logger.info("üß† STEP 3: Qwen Refining...")
    supervisor = EmpireSupervisor()
    final_content = supervisor.run(f"Rewrite for blog: {raw_text}. Include visual cues: {visual_desc}")
    title = final_content.split('\n')[0].replace('#', '').strip()

    # 4. DISTRIBUTION BLITZ
    report_log = []
    
    # A. WordPress
    wp = WordPressTool()
    wp_res = wp.publish_article(title, final_content, tags=["AI"])
    report_log.append(f"WordPress: {wp_res}")
    
    # B. Wix
    wix = WixTool()
    wix_res = wix.create_blog_post(title, final_content)
    report_log.append(f"Wix: {wix_res}")
    
    # C. Ayrshare (Socials)
    ayr = AyrshareTool()
    social_res = ayr.post_to_socials(f"New Post: {title} #AI #SA", image_url="https://via.placeholder.com/150")
    report_log.append(f"Ayrshare: {social_res}")
    
    # D. MailChimp
    mc = MailChimpTool()
    email_res = mc.send_campaign(f"Vaal AI: {title}", final_content[:200] + "... Read more on our blog.")
    report_log.append(f"MailChimp: {email_res}")

    # 5. REPORTING: JIRA
    logger.info("üìã STEP 5: Logging to Jira...")
    jira_user = os.getenv("JIRA_USER_EMAIL")
    jira_token = os.getenv("JIRA_API_TOKEN")
    
    if jira_user and jira_token:
        try:
            jira = JIRA(server=JIRA_URL, basic_auth=(jira_user, jira_token))
            jira.create_issue(fields={
                'project': {'key': 'KAN'},
                'summary': f"Omnichannel Pub: {title}",
                'description': "\n".join(report_log),
                'issuetype': {'name': 'Task'},
            })
            logger.info("   ‚úÖ Jira Updated.")
        except Exception as e:
            logger.error(f"Jira Error: {e}")

if __name__ == "__main__":
    run()
EOF

echo "‚úÖ MARKETING STACK UPGRADED."
echo "   - Added: Wix, MailChimp, Ayrshare"
echo "   - Retained: Notion, Aya, Qwen, WordPress, Jira"
