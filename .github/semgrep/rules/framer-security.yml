rules:
  # Critical: SSRF Prevention
  - id: framer-ssrf-bypass
    languages: [javascript, typescript]
    message: |
      CRITICAL: SSRF vulnerability detected. Using startsWith() for URL validation
      can be bypassed with subdomain attacks (e.g., api.hubspot.com.evil.com).
      Use URL parsing instead: new URL(endpoint).hostname === 'api.hubspot.com'
    severity: ERROR
    patterns:
      - pattern: $ENDPOINT.startsWith('https://$HOST')
      - pattern-inside: |
          function handler($REQ, $RES) {
            ...
          }
    paths:
      include: ["**/api/**proxy**.{js,ts}"]
    fix: |
      const url = new URL($ENDPOINT);
      if (!['api.hubspot.com'].includes(url.hostname)) {
        throw new Error('Invalid domain');
      }
    metadata:
      cwe: "CWE-918: Server-Side Request Forgery"
      owasp: "A10:2021 â€“ Server-Side Request Forgery"
      references:
        - "https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html"

  # High: Hardcoded Secrets in Framer Exports
  - id: framer-hardcoded-secret
    languages: [javascript, typescript]
    message: |
      HIGH: Hardcoded credential detected in Framer export. Framer's visual editor
      often encourages inline secrets. Move to environment variables.
    severity: ERROR
    pattern-regex: '(api_key|apiKey|token|secret|password)\s*[:=]\s*["''][A-Za-z0-9-_]{20,}["'']'
    paths:
      include: ["src/**", "components/**"]
      exclude: ["**/*.test.{js,ts}", "**/*.spec.{js,ts}"]
    fix-regex:
      regex: '(api_key|apiKey)\s*[:=]\s*["'']([A-Za-z0-9-_]+)["'']'
      replacement: '$1: process.env.NEXT_PUBLIC_API_KEY'

  # High: Direct Fetch in Components (Bypass Proxy)
  - id: framer-bypass-proxy
    languages: [javascript, typescript]
    message: |
      HIGH: Direct fetch() call in component bypasses security proxy.
      Use /api/framer-proxy to enforce CORS and domain validation.
    severity: WARNING
    patterns:
      - pattern: fetch($URL, ...)
      - pattern-not-inside: |
          fetch('/api/...')
    paths:
      include: ["src/components/**", "src/pages/**"]
      exclude: ["src/api/**"]

  # Medium: Missing Env Var Validation
  - id: framer-missing-env-check
    languages: [javascript, typescript, jsx, tsx]
    message: |
      MEDIUM: Environment variable used without validation. In SSG/ISR,
      NEXT_PUBLIC_ vars may be undefined during hydration, causing runtime errors.
    severity: WARNING
    patterns:
      - pattern: process.env.$VAR
      - pattern-not-inside: |
          if (process.env.$VAR) { ... }
      - pattern-not-inside: |
          const $X = process.env.$VAR || '...'
    paths:
      include: ["src/**"]

  # Medium: Race Condition in Form Submission
  - id: framer-form-race-condition
    languages: [javascript, typescript, tsx]
    message: |
      MEDIUM: Form submission doesn't check if env vars are loaded.
      Add loading state to prevent submitting to 'undefined'.
    severity: WARNING
    patterns:
      - pattern: |
          <form onSubmit={$HANDLER}>
            ...
          </form>
      - pattern-inside: |
          function $COMPONENT() {
            ...
            const endpoint = process.env.NEXT_PUBLIC_$VAR
            ...
          }
      - pattern-not-inside: |
          const [isLoading, setLoading] = useState(...)
          ...
          disabled={isLoading}

  # Low: Outdated Framer Export Detection
  - id: framer-legacy-export-pattern
    languages: [javascript]
    message: |
      LOW: This file may be from an older Framer export. Modern exports use
      different patterns. Re-export from Framer to ensure compatibility.
    severity: INFO
    pattern-regex: '// This file was generated by Framer X'
    paths:
      include: ["src/**"]
