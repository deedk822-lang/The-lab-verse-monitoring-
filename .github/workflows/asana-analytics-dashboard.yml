# Asana Analytics Dashboard Workflow
# Generates comprehensive analytics and insights about task completion patterns
# Creates visual reports and tracks performance metrics over time

name: Asana Analytics Dashboard

on:
  schedule:
    # Run weekly on Sundays at 10 AM UTC
    - cron: '0 10 * * 0'
  workflow_dispatch:
    inputs:
      report_period:
        description: 'Analysis period'
        required: false
        default: '30'
        type: choice
        options:
        - '7'
        - '14' 
        - '30'
        - '90'
      include_charts:
        description: 'Generate visual charts'
        required: false
        default: 'true'
        type: boolean

jobs:
  generate-analytics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install asana pandas matplotlib seaborn requests python-dateutil

      - name: Generate Analytics Report
        id: analytics
        env:
          ASANA_PAT: "${{ secrets.ASANA_PAT }}"
          REPORT_PERIOD: "${{ github.event.inputs.report_period || '30' }}"
          INCLUDE_CHARTS: "${{ github.event.inputs.include_charts || 'true' }}"
        run: python scripts/asana_analytics_generator.py

      - name: Upload Analytics Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analytics-report-${{ github.run_number }}
          path: |
            *.png
            *.csv
            *.json
            *.html
          retention-days: 90

      - name: Deploy to GitHub Pages
        if: github.event_name == 'schedule' || github.event.inputs.include_charts == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: analytics-dashboard
          destination_dir: reports/${{ github.run_number }}

      - name: Update Latest Dashboard
        if: github.event_name == 'schedule' || github.event.inputs.include_charts == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: analytics-dashboard
          destination_dir: latest

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“‹ Asana Analytics Report Generated
          
          **Analysis Period:** ${{ github.event.inputs.report_period || '30' }} days
          **Generated:** $(date -u)
          
          ### Key Metrics
          - **Total Tasks:** ${{ steps.analytics.outputs.total_tasks }}
          - **Completion Rate:** ${{ steps.analytics.outputs.completion_rate }}%
          - **Avg Completion Time:** ${{ steps.analytics.outputs.avg_completion_time }} days
          - **Charts Generated:** ${{ steps.analytics.outputs.charts_generated }}
          
          ### Available Reports
          - ðŸŒ **[Interactive Dashboard](https://deedk822-lang.github.io/The-lab-verse-monitoring-/latest/analytics_dashboard.html)**
          - ðŸ“‹ **CSV Export:** task_details.csv, project_summary.csv
          - ðŸ“ˆ **Charts:** completion_status.png, project_performance.png, completion_trend.png
          - ðŸ“Š **Raw Data:** analytics.json
          
          ### Next Steps
          - Review the interactive dashboard for detailed insights
          - Download CSV files for custom analysis
          - Use insights to optimize task completion strategies
          - Consider adjusting project workflows based on performance data
          EOF