name: Authority Engine - Content Pipeline

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 4 * * *' # Daily at 6 AM SAST (4 AM UTC)
  workflow_dispatch:
    inputs:
      notion_page_id:
        description: 'Notion Page ID'
        default: '2b8af2b8d06b8150a5acfe7aa7d8f221'
        type: string

env:
  ALIBABA_REGION: cn-shanghai
  SECURITY_ANALYZER: "acs:accessanalyzer:cn-shanghai:5212459344287865:analyzer/prod_security_analyzer"

jobs:
  empire_operations:
    runs-on: ubuntu-latest
    name: "Execute Tax Agent & Titans"
    env:
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
      HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}
      OSS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
      OSS_ENDPOINT: https://oss-eu-west-1.aliyuncs.com
      OSS_BUCKET: vaal-vault
      GLEAN_API_KEY: ${{ secrets.GLEAN_API_KEY }}
      GLEAN_API_ENDPOINT: ${{ secrets.GLEAN_API_ENDPOINT }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Empire Core
        run: |
          echo "ðŸ“¦ Installing AI Workforce Dependencies..."
          pip install --upgrade pip

          # Check if requirements file exists
          if [ -f vaal-ai-empire/requirements.txt ]; then
            pip install -r vaal-ai-empire/requirements.txt
          fi

          # Install package if setup.py or pyproject.toml exists
          if [ -f vaal-ai-empire/setup.py ] || [ -f vaal-ai-empire/pyproject.toml ]; then
            pip install -e vaal-ai-empire/
          fi

          # Install core dependencies
          pip install fastapi uvicorn huggingface_hub requests databricks-sdk httpx pandas || true

      - name: ðŸ›¡ï¸ Run Guardian Engine (Crisis Monitor)
        continue-on-error: true
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire

          if [ -f vaal-ai-empire/src/agents/tax_collector.py ]; then
            python3 -c "
          import sys
          from src.agents.tax_collector import TaxAgentMaster
          print('ðŸš€ ACTIVATING GUARDIAN (TITAN MODE)...')
          agent = TaxAgentMaster()
          revenue = agent.execute_revenue_search()
          print(f'ðŸ’° GUARDIAN REPORT: Revenue Generated: R{revenue}')
          " || echo "âš ï¸ Guardian engine not available"
          else
            echo "âš ï¸ Tax collector module not found, skipping..."
          fi

      - name: âœï¸ Run Content Factory (Visionary)
        continue-on-error: true
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire

          if [ -f vaal-ai-empire/src/products/content_studio.py ]; then
            python3 -c "
          import sys
          from src.products.content_studio import ContentStudio
          print('ðŸŽ¨ ACTIVATING CONTENT FACTORY...')
          studio = ContentStudio()
          if studio.client:
              res = studio.generate_social_bundle('Tech Startup', 'AI Automation in South Africa')
              print(f'âœ… ASSET GENERATED: {res}')
          else:
              print('âŒ Studio Offline (Check HF Key)')
          " || echo "âš ï¸ Content factory not available"
          else
            echo "âš ï¸ Content studio module not found, skipping..."
          fi

  generate-and-publish:
    runs-on: ubuntu-latest
    needs: empire_operations
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          else
            echo "No package.json found, creating minimal setup"
            npm init -y
            npm install @notionhq/client axios
          fi

      - name: Fetch Content from Notion
        id: fetch_notion
        continue-on-error: true
        run: |
          mkdir -p tmp

          if [ -z "${{ secrets.NOTION_API_KEY }}" ]; then
            echo "âš ï¸ NOTION_API_KEY not configured"
            echo '# Sample Content' > ./tmp/notion-content.md
            exit 0
          fi

          node -e "
          const { Client } = require('@notionhq/client');
          const notion = new Client({ auth: process.env.NOTION_API_KEY });
          (async () => {
            try {
              const pageId = '${{ github.event.inputs.notion_page_id || '2b8af2b8d06b8150a5acfe7aa7d8f221' }}';
              const blocks = await notion.blocks.children.list({ block_id: pageId });
              const content = blocks.results.map(b => b[b.type]?.text?.[0]?.plain_text || '').join('\n');
              require('fs').writeFileSync('./tmp/notion-content.md', content);
              console.log('Content fetched successfully');
            } catch (error) {
              console.log('Error fetching content:', error.message);
              require('fs').writeFileSync('./tmp/notion-content.md', '# Error fetching content');
            }
          })();
          " || echo "Failed to fetch Notion content"
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Authority Engine Execution Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY

  broadcast_content:
    runs-on: ubuntu-latest
    needs: generate-and-publish
    if: always()
    env:
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
      NOTION_PAGE_ID: ${{ github.event.inputs.notion_page_id }}
      WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
      WORDPRESS_PASSWORD: ${{ secrets.WORDPRESS_PASSWORD }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_LINK }}
      ARYSHARE_API_KEY: ${{ secrets.ARYSHARE_API_KEY }}
      MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
      MANAGE_WIX_API_KEY: ${{ secrets.MANAGE_WIX_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Stack
        run: |
          if [ -f vaal-ai-empire/requirements.txt ]; then
            pip install -r vaal-ai-empire/requirements.txt || true
          fi

          if [ -f vaal-ai-empire/setup.py ] || [ -f vaal-ai-empire/pyproject.toml ]; then
            pip install -e vaal-ai-empire/ || true
          fi

          pip install requests || true

      - name: ðŸš€ Run Pipeline
        continue-on-error: true
        run: |
          if [ -f vaal-ai-empire/scripts/run_authority_pipeline.py ]; then
            python3 vaal-ai-empire/scripts/run_authority_pipeline.py || echo "Pipeline execution failed"
          else
            echo "âš ï¸ Pipeline script not found, skipping..."
          fi

  the_arbiter:
    needs: [empire_operations, generate-and-publish, broadcast_content]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Pipeline Status Report
        run: |
          echo "## ðŸ¦ Empire Daily Report" >> $GITHUB_STEP_SUMMARY
          echo "1. **Guardian Engine:** ${{ needs.empire_operations.result }}" >> $GITHUB_STEP_SUMMARY
          echo "2. **Content Generator:** ${{ needs.generate-and-publish.result }}" >> $GITHUB_STEP_SUMMARY
          echo "3. **Broadcast System:** ${{ needs.broadcast_content.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Execution Cycle Complete." >> $GITHUB_STEP_SUMMARY
