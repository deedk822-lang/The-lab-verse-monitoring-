name: Authority Engine - Content Pipeline

on:
  schedule:
    - cron: '0 4 * * *'  # Daily at 6 AM SAST
  workflow_dispatch:
    inputs:
      notion_page_id:
        description: 'Source Notion Page ID'
        required: true
        default: '2b8af2b8d06b8150a5acfe7aa7d8f221'

jobs:
  broadcast_content:
    runs-on: ubuntu-latest
    name: "Run Authority Pipeline"
    
    env:
      # BRAINS (Qwen, Aya, Mistral)
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}
      
      # SOURCE (Notion)
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
      NOTION_PAGE_ID: ${{ github.event.inputs.notion_page_id }}
      
      # DESTINATIONS (WordPress, Socials, Email)
      # Hardcoded URL for deedk822.wordpress.com is inside the python script default
      WORDPRESS_USER: ${{ secrets.USER_LOGON_NAME }}
      WORDPRESS_PASSWORD: ${{ secrets.WORDPRESS_PASSWORD }}
      ARYSHARE_API_KEY: ${{ secrets.ARYSHARE_API_KEY }}
      MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
      MANAGE_WIX_API_KEY: ${{ secrets.MANAGE_WIX_API_KEY }}
      
      # REPORTING (Jira)
      JIRA_USER_EMAIL: ${{ secrets.USER_LOGON_NAME }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_LINK }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Empire Dependencies
        run: |
          # 1. Install Base Requirements
          pip install -r vaal-ai-empire/requirements.txt
          # 2. Install Project Package
          pip install -e vaal-ai-empire/
          # 3. Install Specific Drivers for this Job
          pip install notion-client python-wordpress-xmlrpc jira mailchimp-marketing requests

      - name: ðŸš€ Run Omnichannel Pipeline
        run: |
          # Executes the Real Script (Not inline echoes)
          python3 vaal-ai-empire/scripts/run_authority_pipeline.py

      - name: ðŸ“Š Pipeline Summary
        if: always()
        run: |
          echo "## Authority Engine Report ðŸ¦" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline execution finished." >> $GITHUB_STEP_SUMMARY
