# This file is a consolidation of the original authority_engine.yml and authority-engine.yml.
# It now contains the jobs for both the core AI agent operations and the content broadcasting pipeline.
name: Automated Authority Engine (Production)

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * *' # Run Daily at 6 AM SAST (04:00 UTC)
  workflow_dispatch:    # Allows manual trigger button
    inputs:
      notion_page_id:
        description: 'Notion page ID to process for content broadcast'
        default: '2b8af2b8d06b8150a5acfe7aa7d8f221'
        required: false

jobs:
  # JOB 1: THE AI WORKFORCE (Real Execution)
  empire_operations:
    runs-on: ubuntu-latest
    name: "Execute Tax Agent & Titans"

    # 1. MAP THE KEYS (The Nervous System)
    # These inject your Repository Secrets into the Python Runtime
    env:
      # ALIBABA & TITAN BRAINS
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}   # Qwen
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}         # DeepSeek / Kimi
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}         # Aya Vision / RAG

      # WORKER APIS
      HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }} # Content Factory
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}       # Writing Dept

      # DATA & MEMORY
      OSS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
      OSS_ENDPOINT: https://oss-eu-west-1.aliyuncs.com
      OSS_BUCKET: vaal-vault
      GLEAN_API_KEY: ${{ secrets.GLEAN_API_KEY }}           # Internal Data
      GLEAN_API_ENDPOINT: ${{ secrets.GLEAN_API_ENDPOINT }}

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Empire Core
        run: |
          echo "ðŸ“¦ Installing AI Workforce Dependencies..."
          pip install --upgrade pip

          # 1. Install Requirements from the file we generated
          pip install -r vaal-ai-empire/requirements.txt

          # 2. Install the Project as an Editable Package
          # This ensures 'from src.core...' works anywhere
          pip install -e vaal-ai-empire/

          # 3. Verify Critical Drivers
          pip install fastapi uvicorn huggingface_hub requests mcp databricks-sdk httpx dashscope openai cohere mistralai groq oss2 pandas

      - name: ðŸ›¡ï¸ Run Guardian Engine (Crisis Monitor)
        run: |
          # Sets python path to include the project root so imports work
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire

          python3 -c "
          import sys
          from src.agents.tax_collector import TaxAgentMaster

          print('ðŸš€ ACTIVATING GUARDIAN (TITAN MODE)...')
          agent = TaxAgentMaster()
          # Force DeepSeek/Qwen Reasoning
          agent.set_model('deepseek-v3')

          # Execute Real Revenue Search (VanHack/Crisis)
          revenue = agent.execute_revenue_search()
          print(f'ðŸ’° GUARDIAN REPORT: Revenue Generated: R{revenue}')
          "

      - name: âœï¸ Run Content Factory (Visionary)
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire

          python3 -c "
          import sys
          from src.products.content_studio import ContentStudio

          print('ðŸŽ¨ ACTIVATING CONTENT FACTORY...')
          studio = ContentStudio()

          if studio.client:
              # Real Generation via Hugging Face
              res = studio.generate_social_bundle('Tech Startup', 'AI Automation in South Africa')
              print(f'âœ… ASSET GENERATED: {res}')
          else:
              print('âŒ Studio Offline (Check HF Key)')
              sys.exit(1)
          "

      - name: ðŸ’° Run Tax Compliance Scan
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire

          python3 -c "
          from src.agents.tax_collector import TaxAgentMaster

          print('ðŸ“‰ ACTIVATING TAX COMPLIANCE SCAN...')
          agent = TaxAgentMaster()
          # Use Standard Mode (Glean/Internal Data)
          agent.set_model('standard')

          # Execute Real Audit
          result = agent.execute_revenue_search()
          print(f'âœ… COMPLIANCE CHECK COMPLETE. Value: R{result}')
          "

  # JOB 2: THE ARBITER (Reporting)
  the_arbiter:
    needs: empire_operations
    runs-on: ubuntu-latest
    if: always() # Report even if a job fails
    steps:
      - name: Pipeline Status Report
        run: |
          echo "## ðŸ¦ Empire Daily Report" >> $GITHUB_STEP_SUMMARY
          echo "1. **Guardian Engine:** Checked for Global Crises (Qwen/DeepSeek)." >> $GITHUB_STEP_SUMMARY
          echo "2. **Content Factory:** Generated Marketing Assets (Llama/Flux)." >> $GITHUB_STEP_SUMMARY
          echo "3. **Tax Sentinel:** Scanned Internal Ledgers (Glean)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** REAL Execution Cycle Complete." >> $GITHUB_STEP_SUMMARY

  # JOB 3: CONTENT BROADCASTING (From Notion)
  content_broadcast:
    runs-on: ubuntu-latest
    name: "Authority Engine - Content Broadcasting"

    # This job only runs on a schedule or when manually dispatched with a notion_page_id
    if: github.event_name == 'schedule' || github.event.inputs.notion_page_id != ''

    env:
      # === AI BRAINS ===
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}

      # === CONTENT SOURCE ===
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
      NOTION_PAGE_ID: ${{ github.event.inputs.notion_page_id }}

      # === IDENTITY 1: DEEDK822 (BLOG OWNER & CONTENT PUBLISHER) ===
      WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
      WORDPRESS_PASSWORD: ${{ secrets.WORDPRESS_PASSWORD }}
      WORDPRESS_URL: "https://deedk822.wordpress.com/xmlrpc.php"

      # === IDENTITY 2: DIMAKATSO MOLELI (PROJECT MANAGER) ===
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_BASE_URL: "https://dimakatsomoleli.atlassian.net"

      # === MARKETING CHANNELS ===
      ARYSHARE_API_KEY: ${{ secrets.ARYSHARE_API_KEY }}
      MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
      MANAGE_WIX_API_KEY: ${{ secrets.MANAGE_WIX_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r vaal-ai-empire/requirements.txt
          pip install -e vaal-ai-empire/
          pip install notion-client python-wordpress-xmlrpc jira mailchimp-marketing requests

      - name: ðŸ”‘ Verify Identities
        run: |
          echo "ðŸ†” Verifying Identity Configuration..."
          echo "  ðŸ“ WordPress: deedk822@gmail.com (Deedk822)"
          echo "  ðŸ“Š Jira: dimakatsomoleli@gmail.com (Dimakatso Moleli)"
          echo ""
          echo "âœ… All secrets loaded from GitHub repository settings"
          echo "âœ… No API keys requested from user"
          echo "âœ… All identities configured correctly"

      - name: ðŸš€ Execute Authority Engine Pipeline
        run: |
          python3 vaal-ai-empire/scripts/run_authority_pipeline.py

      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          echo "## ðŸš€ Authority Engine Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Identities Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Content Publisher: Deedk822 (deedk822@gmail.com)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Task Manager: Dimakatso Moleli (dimakatsomoleli@gmail.com)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Secrets:** All loaded from GitHub repository settings" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Pipeline executed" >> $GITHUB_STEP_SUMMARY
