name: Automated Authority Engine (Production)

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 4 * * *'  # Daily at 6 AM SAST
  workflow_dispatch:
    inputs:
      notion_page_id:
        description: 'Notion page ID to process'
        default: '2b8af2b8d06b8150a5acfe7aa7d8f221'
        required: false

jobs:
  # JOB 1: THE AI WORKFORCE (Real Execution)
  empire_operations:
    runs-on: ubuntu-latest
    name: "Execute Tax Agent & Titans"

    # 1. MAP THE KEYS (The Nervous System)
    # These inject your Repository Secrets into the Python Runtime
    env:
      # ALIBABA & TITAN BRAINS
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}   # Qwen
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}         # DeepSeek / Kimi
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}         # Aya Vision / RAG
      
      # WORKER APIS
      HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }} # Content Factory
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}       # Writing Dept
      
      # DATA & MEMORY
      OSS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
      OSS_ENDPOINT: https://oss-eu-west-1.aliyuncs.com
      OSS_BUCKET: vaal-vault
      GLEAN_API_KEY: ${{ secrets.GLEAN_API_KEY }}           # Internal Data
      GLEAN_API_ENDPOINT: ${{ secrets.GLEAN_API_ENDPOINT }}

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Empire Core
        run: |
          echo "ðŸ“¦ Installing AI Workforce Dependencies..."
          pip install --upgrade pip
          
          # 1. Install Requirements from the file we generated
          pip install -r vaal-ai-empire/requirements.txt
          
          # 2. Install the Project as an Editable Package
          # This ensures 'from src.core...' works anywhere
          pip install -e vaal-ai-empire/
          
          # 3. Verify Critical Drivers
          pip install fastapi uvicorn huggingface_hub requests mcp databricks-sdk httpx dashscope openai cohere mistralai groq oss2 pandas

      - name: ðŸ›¡ï¸ Run Guardian Engine (Crisis Monitor)
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire
          python3 vaal-ai-empire/scripts/run_guardian_engine.py

      - name: âœï¸ Run Content Factory (Visionary)
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire
          python3 vaal-ai-empire/scripts/run_content_factory.py

      - name: ðŸ’° Run Tax Compliance Scan
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/vaal-ai-empire
          python3 vaal-ai-empire/scripts/run_tax_compliance.py

  # JOB 2: THE ARBITER (Reporting)
  the_arbiter:
    needs: empire_operations
    runs-on: ubuntu-latest
    if: always() # Report even if a job fails
    steps:
      - name: Pipeline Status Report
        run: |
          echo "## ðŸ¦ Empire Daily Report" >> $GITHUB_STEP_SUMMARY
          echo "1. **Guardian Engine:** Checked for Global Crises (Qwen/DeepSeek)." >> $GITHUB_STEP_SUMMARY
          echo "2. **Content Factory:** Generated Marketing Assets (Llama/Flux)." >> $GITHUB_STEP_SUMMARY
          echo "3. **Tax Sentinel:** Scanned Internal Ledgers (Glean)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** REAL Execution Cycle Complete." >> $GITHUB_STEP_SUMMARY

  broadcast_content:
    runs-on: ubuntu-latest
    name: "Authority Engine - Content Broadcasting"

    env:
      # ========================================================================
      # ALL CREDENTIALS BELOW ARE LOADED FROM GITHUB SECRETS
      # NO API KEYS ARE HARDCODED - ALL VALUES COME FROM:
      # https://github.com/deedk822-lang/The-lab-verse-monitoring-/settings/secrets/actions
      # ========================================================================

      # === AI BRAINS ===
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}   # âœ… Already set in GitHub Secrets
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}         # âœ… Already set in GitHub Secrets
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}     # âœ… Already set in GitHub Secrets

      # === CONTENT SOURCE ===
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}         # âœ… Already set in GitHub Secrets
      NOTION_PAGE_ID: ${{ github.event.inputs.notion_page_id }}

      # === IDENTITY 1: DEEDK822 (BLOG OWNER & CONTENT PUBLISHER) ===
      # WordPress publishing identity
      # Email: deedk822@gmail.com
      # Site: deedk822.wordpress.com
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}         # âœ… Already set in GitHub Secrets
      WORDPRESS_PASSWORD: ${{ secrets.WORDPRESS_PASSWORD }} # âœ… Already set in GitHub Secrets
      WORDPRESS_URL: "https://deedk822.wordpress.com/xmlrpc.php"  # Public URL (not secret)

      # === IDENTITY 2: DIMAKATSO MOLELI (PROJECT MANAGER) ===
      # Jira task tracking identity
      # Email: dimakatsomoleli@gmail.com
      # Jira: dimakatsomoleli.atlassian.net
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}      # âœ… Already set in GitHub Secrets
      JIRA_API_TOKEN: ${{ secrets.JIRA_LINK }}             # âœ… Already set in GitHub Secrets
      JIRA_BASE_URL: "https://dimakatsomoleli.atlassian.net"  # Public URL (not secret)

      # === MARKETING CHANNELS ===
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      ARYSHARE_API_KEY: ${{ secrets.ARYSHARE_API_KEY }}    # âœ… Already set in GitHub Secrets
      MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}  # âœ… Already set in GitHub Secrets
      MANAGE_WIX_API_KEY: ${{ secrets.MANAGE_WIX_API_KEY }} # âœ… Already set in GitHub Secrets

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r vaal-ai-empire/requirements.txt
          pip install -e vaal-ai-empire/
          pip install notion-client python-wordpress-xmlrpc jira mailchimp-marketing requests

      - name: ðŸ”‘ Verify Identities
        run: |
          echo "ðŸ†” Verifying Identity Configuration..."
          echo "  ðŸ“ WordPress: deedk822@gmail.com (Deedk822)"
          echo "  ðŸ“Š Jira: dimakatsomoleli@gmail.com (Dimakatso Moleli)"
          echo ""
          echo "âœ… All secrets loaded from GitHub repository settings"
          echo "âœ… No API keys requested from user"
          echo "âœ… All identities configured correctly"

      - name: ðŸš€ Execute Authority Engine Pipeline
        run: |
          python3 vaal-ai-empire/scripts/run_authority_pipeline.py

      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          echo "## ðŸš€ Authority Engine Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Identities Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Content Publisher: Deedk822 (deedk822@gmail.com)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Task Manager: Dimakatso Moleli (dimakatsomoleli@gmail.com)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Secrets:** All loaded from GitHub repository settings" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Pipeline executed" >> $GITHUB_STEP_SUMMARY
