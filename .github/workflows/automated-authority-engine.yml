#!/bin/bash
set -e

echo "‚öîÔ∏è RESOLVING FINAL WORKFLOW CONFLICTS..."
echo "   - Mode: Live Run (Real Execution)"
echo "   - Architecture: Alibaba Native (OSS) + Titans (DeepSeek/Qwen)"
echo "   - Fixes: Merged cleanup logic with revenue logic."

# CREATE THE DEFINITIVE WORKFLOW FILE
cat << 'EOF' > .github/workflows/automated-authority-engine.yml
name: Automated Authority Engine (Live Run)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # JOB 1: THE AI WORKFORCE (Real Execution)
  empire_operations:
    runs-on: ubuntu-latest
    name: "Execute Tax Agent & Titans"

    # 1. MAP THE KEYS (Alibaba Native Architecture)
    env:
      # BRAINS
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}         
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}         
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}   
      
      # WORKERS
      HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }} 
      MISTRAL_API_KEY: ${{ secrets.MISTRALAI_API_KEY }}       
      
      # STORAGE (Alibaba Native - Singapore)
      OSS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
      OSS_ENDPOINT: https://oss-eu-west-1.aliyuncs.com
      OSS_BUCKET: vaal-vault
      
      # GLOBAL PATH
      PYTHONPATH: ${{ github.workspace }}/vaal-ai-empire

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Empire Core
        run: |
          echo "üì¶ Installing AI Workforce..."
          pip install --upgrade pip

          # FIX: Clean artifacts to prevent 'Multiple .egg-info' crash
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true

          # 1. Install Requirements
          pip install -r vaal-ai-empire/requirements.txt
          
          # 2. Install Package (Editable)
          pip install -e vaal-ai-empire/
          
          # 3. Ensure Drivers
          pip install fastapi uvicorn huggingface_hub requests mcp httpx dashscope openai cohere mistralai groq oss2 pandas pypdf

      - name: üõ°Ô∏è Run Guardian Engine (Crisis Monitor)
        run: |
          python3 -c "
          import sys
          from src.agents.tax_collector import TaxAgentMaster
          
          print('üöÄ ACTIVATING GUARDIAN (TITAN MODE)...')
          agent = TaxAgentMaster()
          
          # Force DeepSeek/Qwen Reasoning for High Value Checks
          agent.set_model('deepseek-v3') 
          
          # Execute Real Revenue Search
          revenue = agent.execute_revenue_search()
          print(f'üí∞ GUARDIAN REPORT: Revenue Generated: R{revenue}')
          "

      - name: ‚úçÔ∏è Run Content Factory (Visionary)
        run: |
          python3 -c "
          import sys
          from src.products.content_studio import ContentStudio
          
          print('üé® ACTIVATING CONTENT FACTORY...')
          try:
              studio = ContentStudio()
              # Real Generation via Hugging Face
              res = studio.generate_social_bundle('Tech Startup', 'AI Automation in South Africa')
              print(f'‚úÖ ASSET GENERATED: {res}')
          except Exception as e:
              print(f'‚ö†Ô∏è Content Studio skipped: {e}')
          "

      - name: üí∞ Run Tax Compliance Scan (SARS)
        run: |
          python3 -c "
          from src.agents.tax_collector import TaxAgentMaster
          
          print('üìâ ACTIVATING SARS CASH FLOW MINER...')
          agent = TaxAgentMaster()
          
          # Use Standard Mode (Checks internal OSS Vault)
          agent.set_model('standard') 
          
          # Execute Real Audit
          result = agent.execute_revenue_search()
          print(f'‚úÖ COMPLIANCE CHECK COMPLETE. Value: R{result}')
          "

  # JOB 2: THE ARBITER (System Optimization)
  the_arbiter:
    needs: empire_operations
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report Status
        run: echo "‚úÖ Empire Cycle Complete. Revenue & Compliance Logs Updated."
EOF

echo "‚úÖ WORKFLOW CONFLICT RESOLVED."
echo "   - Environment: Alibaba Native (OSS Keys Mapped)"
echo "   - Cleanup: Added .egg-info removal"
echo "   - Logic: Points to SARS and Titan logic"
