name: Automated Authority and Impact Engine

on:
  workflow_dispatch:
    inputs:
      keyword:
        description: 'The keyword or topic for the main content generation'
        required: true
        default: 'AI in South Africa'
      product_title:
        description: 'Title for the digital product to be created'
        required: false
        default: 'AI Strategy Guide'
      product_description:
        description: 'Description for the digital product'
        required: false
        default: 'A comprehensive guide to implementing AI in your business.'
      product_price:
        description: 'Price for the digital product (in ZAR)'
        required: false
        default: '299.00'
      product_file_path:
        description: 'Path to the file for the digital product'
        required: false
        default: './assets/ai_strategy_guide.pdf'

jobs:
  the_visionary:
    runs-on: ubuntu-latest
    name: 'Run The Visionary (Content Generation)'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Run Visionary Script (Simulated)
        id: visionary_execution
        env:
          WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
          WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
          LOCALAI_API_URL: ${{ secrets.LOCALAI_API_URL }}
        run: |
          # This is a placeholder for the actual Visionary script execution.
          echo "Simulating content generation for keyword: ${{ github.event.inputs.keyword }}"
          echo "Posting to ${{ secrets.WORDPRESS_URL }}..."
          echo "post_id=123" >> $GITHUB_OUTPUT

  the_tax_collector:
    needs: [the_visionary]
    runs-on: ubuntu-latest
    name: 'Run The Tax Collector Agent'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Execute Tax Collector Script
        id: tax_collector_execution
        run: python scripts/tax_collector.py

      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tax-collector-report
          path: ./tax_collector_report.json

  create_digital_product:
    runs-on: ubuntu-latest
    name: 'Create EDD Digital Product'
    if: "github.event.inputs.product_title != ''"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Create Dummy Product File
        run: |
          mkdir -p assets
          echo "This is a dummy file for the AI Strategy Guide." > ${{ github.event.inputs.product_file_path }}

      - name: Execute Create EDD Product Script
        id: create_product_execution
        env:
          WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
          WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
        run: |
          python scripts/create_edd_product.py \
            --title "${{ github.event.inputs.product_title }}" \
            --description "${{ github.event.inputs.product_description }}" \
            --price "${{ github.event.inputs.product_price }}" \
            --file_path "${{ github.event.inputs.product_file_path }}"

  gmail_monetization_workflow:
    runs-on: ubuntu-latest
    name: 'Run Gmail Monetization Workflow'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute Gmail Monetization Script
        id: gmail_monetization_execution
        env:
          WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
          WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
          GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
        run: |
          echo "${{ secrets.GMAIL_TOKEN_JSON }}" > token.json
          echo "${{ secrets.GMAIL_CREDENTIALS_JSON }}" > credentials.json
          python scripts/gmail_monetization_workflow.py --token_path token.json --credentials_path credentials.json
