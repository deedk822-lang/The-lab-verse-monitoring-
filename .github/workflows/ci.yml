# =============================================================================
# Elite Monorepo CI/CD with Advanced Caching
# Based on 2026 GitHub Actions best practices and industry standards
# =============================================================================

name: Elite Monorepo CI/CD

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
    paths:
      - 'rainmaker_orchestrator/**'
      - 'agents/**'
      - 'api/**'
      - 'requirements.txt'
      - 'package*.json'
      - '.github/workflows/**'

# Cancel in-progress runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  CACHE_VERSION: v4  # Bump to invalidate all caches

jobs:
  # ==========================================================================
  # STEP 1: Detect which parts of monorepo changed
  # ==========================================================================
  detect-changes:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      agents: ${{ steps.filter.outputs.agents }}
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      any_python: ${{ steps.filter.outputs.orchestrator == 'true' || steps.filter.outputs.agents == 'true' || steps.filter.outputs.api == 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            orchestrator:
              - 'rainmaker_orchestrator/**'
              - 'requirements.txt'
            agents:
              - 'agents/**'
            api:
              - 'api/**'
            frontend:
              - 'frontend/**'
              - 'package*.json'

  # ==========================================================================
  # STEP 2: Setup shared caches (runs once)
  # ==========================================================================
  setup-caches:
    name: Setup Shared Caches
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_python == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Built-in pip caching
      
      # Restore global pip cache
      - name: Restore pip cache
        id: pip-cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-
            pip-${{ env.CACHE_VERSION }}-${{ runner.os }}-
      
      # Install only if cache miss
      - name: Install base dependencies
        if: steps.pip-cache.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-asyncio pytest-cov black ruff mypy safety bandit interrogate
      
      # Save cache
      - name: Save pip cache
        if: steps.pip-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/pip
          key: ${{ steps.pip-cache.outputs.cache-primary-key }}

  # ==========================================================================
  # STEP 3: Test Orchestrator (if changed)
  # ==========================================================================
  test-orchestrator:
    name: Test Orchestrator (Py ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-caches]
    if: needs.detect-changes.outputs.orchestrator == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f rainmaker_orchestrator/requirements.txt ]; then
            pip install -r rainmaker_orchestrator/requirements.txt
          fi
          pip install pytest pytest-asyncio pytest-cov
          pip check
      
      - name: Run orchestrator tests
        run: |
          pytest rainmaker_orchestrator/tests/ \
            --cov=rainmaker_orchestrator \
            --cov-report=xml \
            --cov-report=term \
            -v
      
      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: orchestrator

  # ==========================================================================
  # STEP 4: Code Quality (runs in parallel)
  # ==========================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_python == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install quality tools
        run: |
          pip install black ruff mypy interrogate
      
      - name: Run checks
        run: |
          # Black formatting
          black --check . &
          BLACK_PID=$!
          
          # Ruff linting
          ruff check . &
          RUFF_PID=$!
          
          # MyPy type checking
          mypy rainmaker_orchestrator/ &
          MYPY_PID=$!

          # Interrogate (docstrings)
          interrogate -v rainmaker_orchestrator/ --fail-under 80 &
          DOC_PID=$!
          
          # Wait for all
          wait $BLACK_PID || echo "black-failed" >> /tmp/failures.txt
          wait $RUFF_PID || echo "ruff-failed" >> /tmp/failures.txt
          wait $MYPY_PID || echo "mypy-failed" >> /tmp/failures.txt
          wait $DOC_PID || echo "interrogate-failed" >> /tmp/failures.txt
          
          # Check if any failed
          if [ -f /tmp/failures.txt ]; then
            echo "Quality checks failed:"
            cat /tmp/failures.txt
            exit 1
          fi

  # ==========================================================================
  # STEP 5: Docker Build with Layer Caching
  # ==========================================================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.orchestrator == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build orchestrator image
        uses: docker/build-push-action@v5
        with:
          context: ./rainmaker_orchestrator
          file: ./rainmaker_orchestrator/Dockerfile
          push: false
          tags: rainmaker-orchestrator:test
          load: true

  # ==========================================================================
  # STEP 6: Security Scanning
  # ==========================================================================
  security:
    name: Security Scans
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_python == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r rainmaker_orchestrator/ -f json -o bandit-report.json
      
      - name: Run Safety dependency check
        run: |
          pip install safety
          safety check --json
      
      - name: Upload security results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json

  # ==========================================================================
  # FINAL: All Checks Passed
  # ==========================================================================
  all-checks-passed:
    name: ✅ All Checks Passed
    runs-on: ubuntu-latest
    needs: [test-orchestrator, code-quality, security, docker-build]
    if: always()
    steps:
      - name: Check all required jobs succeeded
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "Some checks failed"
            exit 1
          fi
          echo "✅ All checks passed!"
