name: Elite Monorepo CI/CD

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
    paths:
      - 'rainmaker_orchestrator/**'
      - 'agents/**'
      - 'api/**'
      - 'requirements.txt'
      - 'package*.json'
      - '.github/workflows/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  CACHE_VERSION: v4

jobs:
  detect-changes:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      agents: ${{ steps.filter.outputs.agents }}
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      any_python: ${{ steps.filter.outputs.orchestrator == 'true' || steps.filter.outputs.agents == 'true' || steps.filter.outputs.api == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            orchestrator:
              - 'rainmaker_orchestrator/**'
              - 'requirements.txt'
            agents:
              - 'agents/**'
            api:
              - 'api/**'
            frontend:
              - 'frontend/**'
              - 'package*.json'

  setup-caches:
    name: Setup Shared Caches
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_python == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Restore pip cache
        id: pip-cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
      - name: Install base dependencies
        if: steps.pip-cache.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-cov ruff black mypy
      - name: Save pip cache
        if: steps.pip-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/pip
          key: ${{ steps.pip-cache.outputs.cache-primary-key }}

  test-orchestrator:
    name: Test Orchestrator (Py ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-caches]
    if: needs.detect-changes.outputs.orchestrator == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r rainmaker_orchestrator/requirements.txt
          pip check # Fail on dependency conflicts
      - name: Run tests
        run: |
          pytest rainmaker_orchestrator/tests/ --cov=rainmaker_orchestrator --cov-report=xml -v

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_python == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install quality tools
        run: pip install ruff black mypy
      - name: Run checks
        run: |
          black --check . &
          ruff check . &
          mypy rainmaker_orchestrator/ &
          wait

  docker-compose-test:
    name: üê≥ Integration Test
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.orchestrator == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Build and Start
        run: |
          touch orchestrator_config.yaml
          docker build -t rainmaker-orchestrator:latest ./rainmaker_orchestrator
          docker compose -f docker-compose.superstack.yml up -d rainmaker-orchestrator
          sleep 20
      - name: Health Check
        run: |
          curl -s -f http://localhost:8080/health || (docker logs task-router && exit 1)

  all-checks-passed:
    name: ‚úÖ All Checks Passed
    runs-on: ubuntu-latest
    needs: [test-orchestrator, code-quality, docker-compose-test]
    if: always()
    steps:
      - name: Verify Success
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            exit 1
          fi
