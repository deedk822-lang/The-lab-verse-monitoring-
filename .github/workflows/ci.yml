 feat/MODULE-ID-1234-multi-service-setup-15915937522088223393
name: CI/CD Pipeline

 dual-agent-cicd-pipeline-1349139378403618497
 feat/integrate-alibaba-access-analyzer-12183567303830527494
 feat/integrate-alibaba-access-analyzer-12183567303830527494
name: Python CI/CD Pipeline

 feat/ci-cd-alibaba-cloud-integration-10364585358297276748
# .github/workflows/ci.yml
name: CI/CD Pipeline with Alibaba Cloud
 main
 main

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

 feat/MODULE-ID-1234-multi-service-setup-15915937522088223393

 dual-agent-cicd-pipeline-1349139378403618497
 dual-agent-cicd-pipeline-1349139378403618497

 feat/integrate-alibaba-access-analyzer-12183567303830527494
 main
jobs:
  test:

env:
  ALIBABA_CLOUD_REGION_ID: ${{ secrets.ALIBABA_CLOUD_REGION_ID }}
  PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}

permissions:
  id-token: write
  contents: read
  actions: read

 main
jobs:
  test-node:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Lint code
        run: npm run lint

 feat/MODULE-ID-1234-multi-service-setup-15915937522088223393
  test-python:

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Configure Alibaba Cloud OIDC
        uses: aliyun/aliyun-oidc-auth-action@v2
        with:
          provider-id: ${{ secrets.ALIBABA_CLOUD_OIDC_PROVIDER_ID }}
          role-arn: ${{ secrets.ALIBABA_CLOUD_OIDC_ROLE_ARN }}

      - name: Install Alibaba Cloud CLI
        run: |
          curl -LO https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar xzvf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun --version

      - name: Run Security Analysis
        run: |
          python3 scripts/alibaba_cloud_security_scan.py

      - name: Build and Push Docker Image
        run: |
          export DOCKER_BUILDKIT=1
          docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker pull ${{ secrets.DOCKER_REGISTRY }}/myapp:latest || true
          docker tag ${{ secrets.DOCKER_REGISTRY }}/myapp:latest ${{ secrets.DOCKER_REGISTRY }}/myapp:previous || true
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }} .
          docker tag ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/myapp:latest
          docker push ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/myapp:latest

      - name: Deploy to Production
        id: deploy
        run: |
          # Create deployment script on target host
          DEPLOY_SCRIPT='#!/bin/bash
          cd /opt/myapp
          export NODE_ENV=production
          export APP_VERSION=${{ github.sha }}
          docker pull ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }}
          docker stop myapp || true
          docker rm myapp || true
          docker run -d --name myapp -p 3000:3000 --restart unless-stopped \
            -e NODE_ENV=$NODE_ENV \
            -e APP_VERSION=$APP_VERSION \
            ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }}
          sleep 10
          # Health check
          if ! curl -f http://localhost:3000/health; then
            echo "Health check failed"
            exit 1
          fi
          echo "Deployment successful"'

          # Execute deployment via Alibaba Cloud Assistant
          COMMAND_ID=$(aliyun ecs RunCommand \
            --RegionId ${{ env.ALIBABA_CLOUD_REGION_ID }} \
            --InstanceIds ${{ secrets.ECS_INSTANCE_ID }} \
            --Type RunShellScript \
            --CommandContent "echo '$DEPLOY_SCRIPT' > /tmp/deploy.sh && chmod +x /tmp/deploy.sh && /tmp/deploy.sh" \
            --output text \
            --query 'CommandId')

          echo "Deployment command submitted: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

          # Wait for command completion
          MAX_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS_OUTPUT=$(aliyun ecs DescribeCommandResult \
              --RegionId ${{ env.ALIBABA_CLOUD_REGION_ID }} \
              --CommandId $COMMAND_ID \
              --output json)

            if [ $? -ne 0 ]; then
              echo "Error getting command result, retrying..."
              sleep 10
              continue
            fi

            STATUS=$(echo "$STATUS_OUTPUT" | jq -r '.InvokeInstances.InvokeInstance[0].Command.Output' 2>/dev/null | base64 -d)

            if [[ "$STATUS" == *"Deployment successful"* ]]; then
              echo "Deployment completed successfully"
              break
            elif [[ "$STATUS" == *"Health check failed"* ]]; then
              echo "Deployment failed: Health check failed"
              exit 1
            else
              echo "Deployment in progress... (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              sleep 10
            fi

            ATTEMPT=$((ATTEMPT+1))
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Timeout waiting for deployment to complete"
            exit 1
          fi

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "Initiating rollback due to deployment failure..."

          ROLLBACK_SCRIPT='#!/bin/bash
          cd /opt/myapp
          # Stop current container
          docker stop myapp || true
          docker rm myapp || true
          # Start previous version if available
          if [ -n "$(docker images -q ${{ secrets.DOCKER_REGISTRY }}/myapp:previous 2>/dev/null)" ]; then
            docker run -d --name myapp -p 3000:3000 --restart unless-stopped \
              ${{ secrets.DOCKER_REGISTRY }}/myapp:previous
            echo "Rollback to previous version completed"
          else
            echo "No previous version to rollback to"
            exit 1
          fi'

          # Execute rollback via Alibaba Cloud Assistant
          ROLLBACK_COMMAND_ID=$(aliyun ecs RunCommand \
            --RegionId ${{ env.ALIBABA_CLOUD_REGION_ID }} \
            --InstanceIds ${{ secrets.ECS_INSTANCE_ID }} \
            --Type RunShellScript \
            --CommandContent "echo '$ROLLBACK_SCRIPT' > /tmp/rollback.sh && chmod +x /tmp/rollback.sh && /tmp/rollback.sh" \
            --output text \
            --query 'CommandId')

          echo "Rollback command submitted: $ROLLBACK_COMMAND_ID"

          # Wait for rollback completion
          MAX_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ROLLBACK_STATUS_OUTPUT=$(aliyun ecs DescribeCommandResult \
              --RegionId ${{ env.ALIBABA_CLOUD_REGION_ID }} \
              --CommandId $ROLLBACK_COMMAND_ID \
              --output json)

            if [ $? -ne 0 ]; then
              echo "Error getting rollback command result, retrying..."
              sleep 10
              continue
            fi

            ROLLBACK_STATUS=$(echo "$ROLLBACK_STATUS_OUTPUT" | jq -r '.InvokeInstances.InvokeInstance[0].Command.Output' 2>/dev/null | base64 -d)

            if [[ "$ROLLBACK_STATUS" == *"Rollback to previous version completed"* ]]; then
              echo "Rollback completed successfully"
              break
            elif [[ "$ROLLBACK_STATUS" == *"No previous version to rollback to"* ]]; then
              echo "Rollback failed: No previous version available"
              exit 1
            else
              echo "Rollback in progress... (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              sleep 10
            fi

            ATTEMPT=$((ATTEMPT+1))
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Timeout waiting for rollback to complete"
            exit 1
          fi
 main

name: Monorepo CI/CD Pipeline

on:
  push:
    branches: [ main, develop, release/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  GO_VERSION: '1.22'
  JAVA_VERSION: '21'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/rainmaker-orchestrator

jobs:
  detect-changes:
    name: "ðŸ” Detect Changed Paths"
    runs-on: ubuntu-latest
    outputs:
      node: ${{ steps.filter.outputs.node }}
      python: ${{ steps.filter.outputs.python }}
      java: ${{ steps.filter.outputs.java }}
      go: ${{ steps.filter.outputs.go }}
      docker: ${{ steps.filter.outputs.docker }}
      agents: ${{ steps.filter.outputs.agents }}
      monitoring: ${{ steps.filter.outputs.monitoring }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            node:
              - 'package.json'
              - 'package-lock.json'
              - 'content-creator-ai/**'
              - 'kimi-computer/**'
              - 'lapverse-*/**/*.ts'
              - 'deal-hunter/**'
            python:
              - 'requirements*.txt'
              - 'agents/**/*.py'
              - 'lab_verse/**/*.py'
              - 'rainmaker_orchestrator/**/*.py'
              - 'rainmaker_orchestrator/requirements*.txt'
            java:
              - 'industrial-chat-api/**'
            go:
              - 'quantumguard-v2/**'
            docker:
              - '**/Dockerfile'
              - '**/docker-compose*.yml'
            agents:
              - 'agents/**'
              - 'lab_verse/**'
            monitoring:
              - 'monitoring/**'
              - 'prometheus/**'

  node-ci:
    name: "ðŸŸ¢ Node.js CI"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.node == 'true'
 main
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - uses: actions/checkout@v4
 feat/MODULE-ID-1234-multi-service-setup-15915937522088223393

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -r rainmaker_orchestrator/requirements.txt

      - name: Run tests
        run: python3 -m pytest rainmaker_orchestrator/

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: '${{ matrix.workspace }}/package-lock.json'
      - name: Install deps
        working-directory: ${{ matrix.workspace }}
        run: |
          if [ -f package-lock.json ]; then npm ci; elif [ -f package.json ]; then npm install; fi
      - name: Lint
        working-directory: ${{ matrix.workspace }}
        run: npm run lint || true
      - name: Test & Build
        working-directory: ${{ matrix.workspace }}
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_ENDPOINT: https://api.example.com
          NEXT_PUBLIC_EVENT_DATE: 2025-01-01
        run: |
          npm test || true
          npm run build || true

  dual-agent-pipeline:
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.python == 'true'
 dual-agent-cicd-pipeline-1349139378403618497
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          # Add test command here
          echo "No tests configured"

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rainmaker_orchestrator/Dockerfile
          push: true
 feat/integrate-alibaba-access-analyzer-12183567303830527494
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/rainmaker-orchestrator:latest

          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security-gate:
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/security-analysis.yml
    secrets: inherit

  deploy-to-alibaba:
    needs: [security-gate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Configure Alibaba Cloud OIDC
        uses: aliyun/aliyun-oidc-auth-action@v1
        with:
          aliyun-role-arn: ${{ secrets.ALIYUN_ROLE_ARN }}
          aliyun-oidc-provider-arn: ${{ secrets.ALIYUN_OIDC_PROVIDER_ARN }}
          aliyun-region-id: ${{ env.ALIYUN_REGION }}

      - name: Deploy to Alibaba Cloud ECS
        run: |
          echo "ðŸš€ Deploying to Alibaba Cloud using secure OIDC authentication..."

          # Run deployment via Cloud Assistant
          aliyun ecs run-command \
            --instance-id "${{ secrets.ECS_INSTANCE_ID }}" \
            --region "${{ env.ALIYUN_REGION }}" \
            --command-content "cd /app/The-lab-verse-monitoring- && git pull && docker inspect $(docker-compose -f docker/compose/docker-compose.prod.yml ps -q rainmaker-orchestrator) --format='{{.Config.Image}}' > /tmp/previous_image.txt && export IMAGE_TAG=${{ github.sha }} && docker-compose -f docker/compose/docker-compose.prod.yml pull && docker-compose -f docker/compose/docker-compose.prod.yml up -d" \
            --timeout 600 \
            --name "deploy-$(date +%Y%m%d-%H%M%S)"

          echo "âœ… Deployment command sent to Alibaba Cloud ECS"

      - name: Verify Deployment
        run: |
          sleep 30 # Wait for the service to start
          for i in {1..10}; do
            if curl -f "http://${{ secrets.ECS_HOST }}:8000/health"; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Health check failed. Retrying in 10 seconds..."
            sleep 10
          done

          echo "Health check failed after multiple retries. Rolling back..."
          aliyun ecs run-command \
            --instance-id "${{ secrets.ECS_INSTANCE_ID }}" \
            --region "${{ env.ALIYUN_REGION }}" \
            --command-content "cd /app/The-lab-verse-monitoring- && if [ -f /tmp/previous_image.txt ]; then export IMAGE_TAG=$(cat /tmp/previous_image.txt | sed 's/.*://') && docker-compose -f docker/compose/docker-compose.prod.yml up -d; else echo 'Rollback image not found'; exit 1; fi" \
            --timeout 600 \
            --name "rollback-$(date +%Y%m%d-%H%M%S)"

          exit 1

  report:
    name: "ðŸ“ Build Report"
    needs: [detect-changes, node-ci, dual-agent-pipeline, build, build-and-push, security-gate, deploy-to-alibaba]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Node CI: ${{ needs.node-ci.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dual-Agent Pipeline: ${{ needs.dual-agent-pipeline.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build and Push: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Gate: ${{ needs.security-gate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy to Alibaba: ${{ needs.deploy-to-alibaba.result }}" >> $GITHUB_STEP_SUMMARY
 feat/integrate-alibaba-access-analyzer-12183567303830527494
 dual-agent-cicd-pipeline-1349139378403618497
 dual-agent-cicd-pipeline-1349139378403618497
 dual-agent-cicd-pipeline-1349139378403618497

 main

 main
 main
 main
