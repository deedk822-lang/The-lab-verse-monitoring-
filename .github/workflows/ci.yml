name: CI/CD Pipeline (Main-Ready Checks)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-type-check:
    runs-on: ubuntu-latest
    name: Lint & Type Safety
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: Run MyPy (Strict Mode)
        run: poetry run mypy --strict rainmaker_orchestrator/ api/
      - name: Run Ruff linter
        run: poetry run ruff check rainmaker_orchestrator/ api/ tests/
      - name: Format check (Black)
        run: poetry run black --check rainmaker_orchestrator/ api/ tests/

  security-audit:
    runs-on: ubuntu-latest
    name: Security & Dependency Audit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: Scan for secrets
        run: |
          poetry run pip install detect-secrets pip-audit
          poetry run detect-secrets scan --baseline .secrets.baseline
      - name: Audit dependencies
        run: poetry run pip-audit

  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests & Coverage
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: Run tests with coverage
        run: poetry run pytest tests/ --cov=rainmaker_orchestrator --cov=api --cov-report=xml --cov-report=term
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests

  integration-tests:
    runs-on: ubuntu-latest
    name: Integration Tests
    env:
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
      MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
      CI: "true"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: Run integration tests
        run: poetry run pytest tests/integration/ -v --tb=short

  opik-telemetry:
    runs-on: ubuntu-latest
    name: Opik & OpenLIT Health Check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: Verify Opik initialization
        run: poetry run python -c "import opik; print('✅ Opik imported successfully')"
      - name: Verify OpenLIT initialization
        run: poetry run python -c "import openlit; print('✅ OpenLIT imported successfully')"
