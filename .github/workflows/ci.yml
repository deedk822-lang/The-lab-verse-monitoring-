name: CI/CD Pipeline (Main-Ready Checks)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  ALIBABA_CLOUD_REGION_ID: ${{ secrets.ALIBABA_CLOUD_REGION_ID }}
  PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

permissions:
  id-token: write
  contents: read
  actions: read
  pull-requests: write
  security-events: write

jobs:
  lint-and-type-check:
    runs-on: ubuntu-latest
    name: Lint & Type Safety
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      - name: Run Linting
        run: |
          pip install ruff black mypy
          ruff check .
          black --check .
          mypy --strict rainmaker_orchestrator/ api/

  test-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      # FIX: Set working directory and verify tests exist
      - name: Verify tests exist
        run: |
          ls -la tests/
          ls -la tests/test_security.py || echo "WARNING: test_security.py missing"
          ls -la tests/test_integration.py || echo "WARNING: test_integration.py missing"
          ls -la tests/test_main.py || echo "WARNING: test_main.py missing"

      # FIX: Run tests with correct coverage path and exit code check
      - name: Run tests with coverage
        working-directory: ${{ github.workspace }}  # FIX: Explicit working directory
        run: |
          # Run pytest with coverage
          pytest -v \
            --cov=src/pr_fix_agent \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            tests/

          # FIX: Explicitly check exit code
          TEST_EXIT_CODE=$?

          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Tests failed with exit code: $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

          echo "‚úÖ All tests passed"

      # FIX: Verify coverage.xml was generated
      - name: Verify coverage file
        run: |
          if [ ! -f coverage.xml ]; then
            echo "‚ùå ERROR: coverage.xml not generated!"
            exit 1
          fi

          # Check coverage.xml has actual data (not 0 hits)
          TOTAL_HITS=$(grep -oP 'hits="\K[0-9]+' coverage.xml | awk '{s+=$1} END {print s}')
          echo "Total coverage hits: $TOTAL_HITS"

          if [ "$TOTAL_HITS" -eq 0 ]; then
            echo "‚ùå ERROR: coverage.xml shows 0 hits - coverage tracked wrong path!"
            echo "Contents of coverage.xml:"
            head -50 coverage.xml
            exit 1
          fi

          echo "‚úÖ Coverage tracking successful: $TOTAL_HITS hits"

  build-and-deploy:
    needs: [lint-and-type-check, test-python]
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Configure Alibaba Cloud OIDC
        uses: aliyun/aliyun-oidc-auth-action@v2
        with:
          provider-id: ${{ secrets.ALIBABA_CLOUD_OIDC_PROVIDER_ID }}
          role-arn: ${{ secrets.ALIBABA_CLOUD_OIDC_ROLE_ARN }}

      - name: Install Alibaba Cloud CLI
        run: |
          curl -LO https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar xzvf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun --version

      - name: Run Security Analysis
        run: |
          python3 scripts/alibaba_cloud_security_scan.py

      - name: Build and Push Docker Image
        run: |
          export DOCKER_BUILDKIT=1
          docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }} .
          docker tag ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/myapp:latest
          docker push ${{ secrets.DOCKER_REGISTRY }}/myapp:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/myapp:latest

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying to Alibaba Cloud ECS..."
          # Deployment logic here
