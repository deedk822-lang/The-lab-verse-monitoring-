name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# Cancel in-progress runs for same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Verify Node.js and npm versions
        run: |
          node --version
          npm --version

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
        env:
          NODE_ENV: development

      - name: Verify package-lock.json
        run: |
          if [ -f package-lock.json ]; then
            echo "âœ… package-lock.json exists"
          else
            echo "âŒ package-lock.json missing"
            exit 1
          fi

      - name: Check for dependency conflicts
        run: |
          npm ls || echo "âš ï¸ Some peer dependencies issues detected but continuing..."

      - name: Run Prettier format check
        run: npm run format:check
        continue-on-error: false

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Run TypeScript type check
        run: npm run typecheck
        continue-on-error: false

      - name: Run tests
        run: npm run test:coverage
        env:
          NODE_ENV: test

      - name: Upload coverage to Codecov
        if: matrix.node-version == '20.x' && github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-${{ matrix.node-version }}
          fail_ci_if_error: false
          continue-on-error: true

      - name: Check bundle size (if applicable)
        if: hashFiles('webpack.config.js') != '' || hashFiles('vite.config.js') != ''
        run: |
          if [ -f "package.json" ]; then
            if grep -q "\"build\"" package.json; then
              npm run build
              echo "âœ… Build completed successfully"
            fi
          fi
        continue-on-error: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run npm audit
        run: |
          npm audit --audit-level=high || echo "âš ï¸ Vulnerabilities found, please review"
        continue-on-error: true

      - name: Check for outdated dependencies
        run: |
          npm outdated || echo "Some packages have newer versions available"
        continue-on-error: true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0

  validate:
    name: Final Validation
    runs-on: ubuntu-latest
    needs: [quality-check, security-audit]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Check all jobs status
        run: |
          quality_check_result="${{ needs.quality-check.result }}"
          security_audit_result="${{ needs.security-audit.result }}"

          echo "Quality Check: $quality_check_result"
          echo "Security Audit: $security_audit_result"

          if [ "$quality_check_result" == "failure" ]; then
            echo "âŒ Quality checks failed!"
            exit 1
          fi

          if [ "$quality_check_result" == "success" ] && [ "$security_audit_result" == "success" ]; then
            echo "âœ… All checks passed successfully!"
            exit 0
          else
            echo "âš ï¸ Some checks had issues"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "### CI/CD Pipeline Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Check**: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Audit**: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: `${{ github.ref_name }}`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: `${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY