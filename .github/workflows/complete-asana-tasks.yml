# Complete Asana Tasks Workflow
# This workflow provides comprehensive task completion capabilities for Asana integration

name: Complete Asana Tasks

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Specific Asana Task ID to complete (optional)'
        required: false
        type: string
      project_id:
        description: 'Asana Project ID to complete all tasks (optional)'
        required: false
        type: string
      task_tag:
        description: 'Complete tasks with this tag (optional)'
        required: false
        type: string
      action_type:
        description: 'Choose completion action'
        required: true
        default: 'single_task'
        type: choice
        options:
        - single_task
        - project_tasks
        - tagged_tasks
        - bulk_complete
      dry_run:
        description: 'Dry run mode (show what would be completed without completing)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      check_dependencies:
        description: 'Check task dependencies before completion'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
  pull_request:
    types: [closed]

env:
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
  CHECK_DEPENDENCIES: ${{ github.event.inputs.check_dependencies || 'false' }}

jobs:
  # Job 1: Complete a specific task by ID
  complete-single-task:
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.action_type == 'single_task' || github.event.inputs.task_id != '')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.task-completion.outputs.completed-count }}
      task-name: ${{ steps.task-completion.outputs.task-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Task ID from PR Body (if PR event)
        if: github.event_name == 'pull_request'
        id: extract-task
        run: |
          TASK_ID=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'asana-task-id: \K\d+' | head -1)
          if [ -z "$TASK_ID" ]; then
            TASK_ID=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'Task ID: \K\d+' | head -1)
          fi
          if [ -z "$TASK_ID" ]; then
            TASK_ID=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'https://app\.asana\.com/\d+/\d+/\K\d+' | head -1)
          fi
          echo "task-id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "Extracted Task ID: $TASK_ID"

      - name: Set Task ID
        id: set-task-id
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TASK_ID="${{ steps.extract-task.outputs.task-id }}"
          else
            TASK_ID="${{ github.event.inputs.task_id }}"
          fi
          echo "task-id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "Using Task ID: $TASK_ID"

      - name: Complete Single Asana Task
        if: steps.set-task-id.outputs.task-id != ''
        id: task-completion
        env:
          ASANA_PAT: "${{ secrets.ASANA_PAT }}"
          TASK_ID: "${{ steps.set-task-id.outputs.task-id }}"
        run: |
          pip install asana
          python scripts/asana_complete_task.py

      - name: Upload Task Backup
        if: steps.set-task-id.outputs.task-id != '' && env.DRY_RUN != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: task-backups
          path: task_backup_*.json
          retention-days: 30

  # Job 2: Complete all tasks in a project
  complete-project-tasks:
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.action_type == 'project_tasks' || github.event.inputs.project_id != '')
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.project-completion.outputs.completed-count }}
      skipped-count: ${{ steps.project-completion.outputs.skipped-count }}
      project-name: ${{ steps.project-completion.outputs.project-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Complete All Tasks in Project
        id: project-completion
        env:
          ASANA_PAT: "${{ secrets.ASANA_PAT }}"
          PROJECT_ID: "${{ github.event.inputs.project_id }}"
        run: |
          pip install asana
          python scripts/asana_complete_project_tasks.py

      - name: Upload Project Report
        uses: actions/upload-artifact@v4
        with:
          name: project-reports
          path: project_completion_*.json
          retention-days: 30

  # Job 3: Complete tasks by tag
  complete-tasks-by-tag:
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.action_type == 'tagged_tasks' || github.event.inputs.task_tag != '')
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.tag-completion.outputs.completed-count }}
      skipped-count: ${{ steps.tag-completion.outputs.skipped-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Complete Tasks by Tag
        id: tag-completion
        env:
          ASANA_PAT: "${{ secrets.ASANA_PAT }}"
          TAG_NAME: "${{ github.event.inputs.task_tag }}"
        run: |
          pip install asana
          python scripts/asana_complete_tagged_tasks.py

  # Job 4: Bulk complete all incomplete tasks (use with caution)
  bulk-complete-all:
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action_type == 'bulk_complete'
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.bulk-completion.outputs.completed-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Bulk Complete All Tasks
        id: bulk-completion
        env:
          ASANA_PAT: "${{ secrets.ASANA_PAT }}"
        run: |
          pip install asana
          python scripts/asana_bulk_complete_all.py

  # Job 5: Enhanced summary and notification with analytics
  notify-completion:
    needs: [complete-single-task, complete-project-tasks, complete-tasks-by-tag, bulk-complete-all]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Calculate Totals
        id: calculate-totals
        run: |
          SINGLE_COMPLETED=${{ needs.complete-single-task.outputs.completed-count || 0 }}
          PROJECT_COMPLETED=${{ needs.complete-project-tasks.outputs.completed-count || 0 }}
          PROJECT_SKIPPED=${{ needs.complete-project-tasks.outputs.skipped-count || 0 }}
          TAG_COMPLETED=${{ needs.complete-tasks-by-tag.outputs.completed-count || 0 }}
          TAG_SKIPPED=${{ needs.complete-tasks-by-tag.outputs.skipped-count || 0 }}
          BULK_COMPLETED=${{ needs.bulk-complete-all.outputs.completed-count || 0 }}
          
          TOTAL_COMPLETED=$((SINGLE_COMPLETED + PROJECT_COMPLETED + TAG_COMPLETED + BULK_COMPLETED))
          TOTAL_SKIPPED=$((PROJECT_SKIPPED + TAG_SKIPPED))
          
          echo "total-completed=$TOTAL_COMPLETED" >> $GITHUB_OUTPUT
          echo "total-skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT

      - name: Enhanced Summary Report
        run: |
          echo "## ðŸ“‹ Asana Task Completion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ env.DRY_RUN == 'true' && 'ðŸ§ª Dry Run' || 'ðŸš€ Live Run' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Action Type:** ${{ github.event.inputs.action_type }}" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ github.event.inputs.task_id }}" ]; then
              echo "**Task ID:** ${{ github.event.inputs.task_id }}" >> $GITHUB_STEP_SUMMARY
              echo "**Task Name:** ${{ needs.complete-single-task.outputs.task-name }}" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "${{ github.event.inputs.project_id }}" ]; then
              echo "**Project ID:** ${{ github.event.inputs.project_id }}" >> $GITHUB_STEP_SUMMARY
              echo "**Project Name:** ${{ needs.complete-project-tasks.outputs.project-name }}" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "${{ github.event.inputs.task_tag }}" ]; then
              echo "**Tag:** ${{ github.event.inputs.task_tag }}" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "**Dependency Check:** ${{ env.CHECK_DEPENDENCIES == 'true' && 'Enabled' || 'Disabled' }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "**Pull Request:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ${{ env.DRY_RUN == 'true' && 'Would Complete' || 'Completed' }}: **${{ steps.calculate-totals.outputs.total-completed }}** tasks" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ Skipped: **${{ steps.calculate-totals.outputs.total-skipped }}** tasks" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ Backups Created: ${{ env.DRY_RUN == 'true' && '0 (dry run)' || steps.calculate-totals.outputs.total-completed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.calculate-totals.outputs.total-completed }}" -gt "0" ]; then
            echo "### ðŸŽ‰ Success!" >> $GITHUB_STEP_SUMMARY
            if [ "${{ env.DRY_RUN }}" == "true" ]; then
              echo "Dry run completed successfully. No tasks were actually completed, but the workflow validated what would happen." >> $GITHUB_STEP_SUMMARY
            else
              echo "Tasks completed successfully! Check the individual job logs for detailed information about each completed task." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No Tasks Processed" >> $GITHUB_STEP_SUMMARY
            echo "No tasks were found that met the completion criteria, or all matching tasks were already completed." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Asana Integration Guide](https://github.com/${{ github.repository }}/blob/main/ASANA_INTEGRATION_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository Issues](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_STEP_SUMMARY
