---
# Complete Asana Tasks Workflow
# This workflow provides comprehensive task completion capabilities for Asana integration

name: Complete Asana Tasks

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Specific Asana Task ID to complete (optional)'
        required: false
        type: string
      project_id:
        description: 'Asana Project ID to complete all tasks (optional)'
        required: false
        type: string
      task_tag:
        description: 'Complete tasks with this tag (optional)'
        required: false
        type: string
      action_type:
        description: 'Choose completion action'
        required: true
        default: 'single_task'
        type: choice
        options:
          - single_task
          - project_tasks
          - tagged_tasks
          - bulk_complete
      dry_run:
        description: 'Dry run mode (show what would be completed without completing)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      check_dependencies:
        description: 'Check task dependencies before completion'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  pull_request:
    types: [closed]

env:
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
  CHECK_DEPENDENCIES: ${{ github.event.inputs.check_dependencies || 'false' }}

jobs:
  # Job 1: Complete a specific task by ID
  complete-single-task:
    if: |
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.action_type == 'single_task' || github.event.inputs.task_id != '')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.task-completion.outputs.completed-count }}
      task-name: ${{ steps.task-completion.outputs.task-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Task ID from PR Body (if PR event)
        if: github.event_name == 'pull_request'
        id: extract-task
        run: |
          TASK_ID=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'asana-task-id: \K\d+' | head -1)
          if [ -z "$TASK_ID" ]; then
            TASK_ID=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'Task ID: \K\d+' | head -1)
          fi
          if [ -z "$TASK_ID" ]; then
            TASK_ID=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'https://app\.asana\.com/\d+/\d+/\K\d+' | head -1)
          fi
          echo "task-id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "Extracted Task ID: $TASK_ID"

      - name: Set Task ID
        id: set-task-id
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TASK_ID="${{ steps.extract-task.outputs.task-id }}"
          else
            TASK_ID="${{ github.event.inputs.task_id }}"
          fi
          echo "task-id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "Using Task ID: $TASK_ID"

      - name: Complete Single Asana Task
        if: steps.set-task-id.outputs.task-id != ''
        id: task-completion
        run: |
          pip install asana
          cat > complete_task.py << 'EOF'
          import asana
          import sys
          import os
          import json

          def check_task_dependencies(client, task_id):
              """Check if task has incomplete dependencies"""
              try:
                  task = client.tasks.find_by_id(task_id, {"opt_fields": "dependencies.completed,dependencies.name"})
                  incomplete_deps = []

                  for dep in task.get('dependencies', []):
                      if not dep.get('completed', True):
                          incomplete_deps.append(dep['name'])

                  return incomplete_deps
              except:
                  return []

          def backup_task_info(client, task_id):
              """Backup task information before completion"""
              try:
                  task = client.tasks.find_by_id(task_id, {
                      "opt_fields": "name,notes,completed,due_date,assignee.name,projects.name,tags.name,created_at,modified_at"
                  })

                  backup_data = {
                      "id": task_id,
                      "name": task['name'],
                      "notes": task.get('notes', ''),
                      "completed": task['completed'],
                      "due_date": task.get('due_date'),
                      "assignee": task.get('assignee', {}).get('name'),
                      "projects": [p['name'] for p in task.get('projects', [])],
                      "tags": [t['name'] for t in task.get('tags', [])],
                      "created_at": task.get('created_at'),
                      "modified_at": task.get('modified_at'),
                      "backup_timestamp": task.get('modified_at')
                  }

                  with open(f'task_backup_{task_id}.json', 'w') as f:
                      json.dump(backup_data, f, indent=2)

                  return backup_data
              except Exception as e:
                  print(f"Warning: Could not backup task info: {str(e)}")
                  return None

          def complete_task(task_id, pat, dry_run=False, check_deps=False):
              try:
                  client = asana.Client.access_token(pat)

                  # Get task details first
                  task = client.tasks.find_by_id(task_id, {"opt_fields": "name,completed"})
                  print(f"Task found: {task['name']}")

                  if task['completed']:
                      print(f"Task '{task['name']}' is already completed.")
                      return True, task['name'], 0

                  # Check dependencies if requested
                  if check_deps:
                      incomplete_deps = check_task_dependencies(client, task_id)
                      if incomplete_deps:
                          print(f"âš ï¸  Task has incomplete dependencies:")
                          for dep in incomplete_deps:
                              print(f"   - {dep}")
                          print(f"Skipping completion due to dependencies.")
                          return True, task['name'], 0

                  if dry_run:
                      print(f"ðŸ§ª DRY RUN: Would complete task '{task['name']}'")
                      return True, task['name'], 1

                  # Backup task information
                  print("ðŸ“„ Backing up task information...")
                  backup_task_info(client, task_id)

                  # Mark task as complete
                  result = client.tasks.update(task_id, {'completed': True})
                  print(f"âœ… Successfully completed task: {task['name']}")
                  return True, task['name'], 1

              except Exception as e:
                  print(f"âŒ Error completing task {task_id}: {str(e)}")
                  return False, None, 0

          if __name__ == "__main__":
              task_id = "${{ steps.set-task-id.outputs.task-id }}"
              pat = "${{ secrets.ASANA_PAT }}"
              dry_run = "${{ env.DRY_RUN }}" == "true"
              check_deps = "${{ env.CHECK_DEPENDENCIES }}" == "true"

              if not pat:
                  print("âŒ ASANA_PAT secret not found. Please add your Asana Personal Access Token to repository secrets.")
                  sys.exit(1)

              success, task_name, completed_count = complete_task(task_id, pat, dry_run, check_deps)

              # Set outputs for GitHub Actions
              with open(os.getenv('GITHUB_OUTPUT', '/dev/stdout'), 'a') as f:
                  f.write(f"completed-count={completed_count}\n")
                  f.write(f"task-name={task_name or 'Unknown'}\n")

              sys.exit(0 if success else 1)
          EOF

          python complete_task.py

      - name: Upload Task Backup
        if: steps.set-task-id.outputs.task-id != '' && env.DRY_RUN != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: task-backups
          path: task_backup_*.json
          retention-days: 30

  # Job 2: Complete all tasks in a project
  complete-project-tasks:
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.action_type == 'project_tasks' || github.event.inputs.project_id != '')
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.project-completion.outputs.completed-count }}
      skipped-count: ${{ steps.project-completion.outputs.skipped-count }}
      project-name: ${{ steps.project-completion.outputs.project-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Complete All Tasks in Project
        id: project-completion
        run: |
          pip install asana
          cat > complete_project_tasks.py << 'EOF'
          import asana
          import sys
          import os
          import json

          def complete_project_tasks(project_id, pat, dry_run=False):
              try:
                  client = asana.Client.access_token(pat)

                  # Get project details
                  project = client.projects.find_by_id(project_id, {"opt_fields": "name"})
                  print(f"Processing project: {project['name']}")

                  # Get all tasks in project
                  tasks = list(client.tasks.find_by_project(project_id, {"opt_fields": "name,completed,due_date"}))

                  if not tasks:
                      print("No tasks found in project")
                      return True, project['name'], 0, 0

                  completed_count = 0
                  skipped_count = 0
                  task_list = []

                  for task in tasks:
                      task_info = {
                          "name": task['name'],
                          "id": task['gid'],
                          "due_date": task.get('due_date'),
                          "was_completed": task['completed']
                      }

                      if not task['completed']:
                          if dry_run:
                              print(f"ðŸ§ª WOULD COMPLETE: {task['name']}")
                              task_info["action"] = "would_complete"
                              completed_count += 1
                          else:
                              print(f"Completing: {task['name']}")
                              client.tasks.update(task['gid'], {'completed': True})
                              task_info["action"] = "completed"
                              completed_count += 1
                      else:
                          task_info["action"] = "already_completed"
                          skipped_count += 1

                      task_list.append(task_info)

                  # Save project completion report
                  report = {
                      "project_name": project['name'],
                      "project_id": project_id,
                      "dry_run": dry_run,
                      "completed_count": completed_count,
                      "skipped_count": skipped_count,
                      "total_tasks": len(tasks),
                      "tasks": task_list
                  }

                  with open(f'project_completion_{project_id}.json', 'w') as f:
                      json.dump(report, f, indent=2)

                  print(f"\nðŸ“Š Summary:")
                  print(f"âœ… {'Would complete' if dry_run else 'Completed'}: {completed_count} tasks")
                  print(f"â­ï¸  Skipped (already complete): {skipped_count} tasks")
                  print(f"ðŸ“ Project: {project['name']}")

                  return True, project['name'], completed_count, skipped_count

              except Exception as e:
                  print(f"âŒ Error processing project {project_id}: {str(e)}")
                  return False, None, 0, 0

          if __name__ == "__main__":
              project_id = "${{ github.event.inputs.project_id }}"
              pat = "${{ secrets.ASANA_PAT }}"
              dry_run = "${{ env.DRY_RUN }}" == "true"

              if not pat:
                  print("âŒ ASANA_PAT secret not found. Please add your Asana Personal Access Token to repository secrets.")
                  sys.exit(1)

              success, project_name, completed_count, skipped_count = complete_project_tasks(project_id, pat, dry_run)

              # Set outputs for GitHub Actions
              with open(os.getenv('GITHUB_OUTPUT', '/dev/stdout'), 'a') as f:
                  f.write(f"completed-count={completed_count}\n")
                  f.write(f"skipped-count={skipped_count}\n")
                  f.write(f"project-name={project_name or 'Unknown'}\n")

              sys.exit(0 if success else 1)
          EOF

          python complete_project_tasks.py

      - name: Upload Project Report
        uses: actions/upload-artifact@v4
        with:
          name: project-reports
          path: project_completion_*.json
          retention-days: 30

  # Job 3: Complete tasks by tag
  complete-tasks-by-tag:
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.action_type == 'tagged_tasks' || github.event.inputs.task_tag != '')
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.tag-completion.outputs.completed-count }}
      skipped-count: ${{ steps.tag-completion.outputs.skipped-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Complete Tasks by Tag
        id: tag-completion
        run: |
          pip install asana
          cat > complete_tagged_tasks.py << 'EOF'
          import asana
          import sys
          import os

          def complete_tagged_tasks(tag_name, pat, dry_run=False):
              try:
                  client = asana.Client.access_token(pat)

                  # Get workspace (use first available)
                  workspaces = list(client.workspaces.find_all())
                  if not workspaces:
                      print("âŒ No workspaces found")
                      return False, 0, 0

                  workspace_id = workspaces[0]['gid']
                  print(f"Using workspace: {workspaces[0]['name']}")

                  # Find the tag
                  tags = list(client.tags.find_by_workspace(workspace_id, {"opt_fields": "name"}))
                  target_tag = None

                  for tag in tags:
                      if tag['name'].lower() == tag_name.lower():
                          target_tag = tag
                          break

                  if not target_tag:
                      print(f"âŒ Tag '{tag_name}' not found in workspace")
                      return False, 0, 0

                  print(f"Found tag: {target_tag['name']}")

                  # Get tasks with this tag
                  tasks = list(client.tasks.find_by_tag(target_tag['gid'], {"opt_fields": "name,completed"}))

                  if not tasks:
                      print(f"No tasks found with tag '{tag_name}'")
                      return True, 0, 0

                  completed_count = 0
                  skipped_count = 0

                  for task in tasks:
                      if not task['completed']:
                          if dry_run:
                              print(f"ðŸ§ª WOULD COMPLETE: {task['name']}")
                              completed_count += 1
                          else:
                              print(f"Completing: {task['name']}")
                              client.tasks.update(task['gid'], {'completed': True})
                              completed_count += 1
                      else:
                          skipped_count += 1

                  print(f"\nðŸ“Š Summary:")
                  print(f"âœ… {'Would complete' if dry_run else 'Completed'}: {completed_count} tasks")
                  print(f"â­ï¸  Skipped (already complete): {skipped_count} tasks")
                  print(f"ðŸ·ï¸  Tag: {tag_name}")

                  return True, completed_count, skipped_count

              except Exception as e:
                  print(f"âŒ Error processing tasks with tag '{tag_name}': {str(e)}")
                  return False, 0, 0

          if __name__ == "__main__":
              tag_name = "${{ github.event.inputs.task_tag }}"
              pat = "${{ secrets.ASANA_PAT }}"
              dry_run = "${{ env.DRY_RUN }}" == "true"

              if not pat:
                  print("âŒ ASANA_PAT secret not found. Please add your Asana Personal Access Token to repository secrets.")
                  sys.exit(1)

              success, completed_count, skipped_count = complete_tagged_tasks(tag_name, pat, dry_run)

              # Set outputs for GitHub Actions
              with open(os.getenv('GITHUB_OUTPUT', '/dev/stdout'), 'a') as f:
                  f.write(f"completed-count={completed_count}\n")
                  f.write(f"skipped-count={skipped_count}\n")

              sys.exit(0 if success else 1)
          EOF

          python complete_tagged_tasks.py

  # Job 4: Bulk complete all incomplete tasks (use with caution)
  bulk-complete-all:
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.action_type == 'bulk_complete'
    runs-on: ubuntu-latest
    outputs:
      completed-count: ${{ steps.bulk-completion.outputs.completed-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bulk Complete All Tasks
        id: bulk-completion
        run: |
          pip install asana
          cat > bulk_complete_all.py << 'EOF'
          import asana
          import sys
          import os

          def bulk_complete_all_tasks(pat, dry_run=False):
              try:
                  client = asana.Client.access_token(pat)

                  # Get workspace (use first available)
                  workspaces = list(client.workspaces.find_all())
                  if not workspaces:
                      print("âŒ No workspaces found")
                      return False, 0

                  workspace_id = workspaces[0]['gid']
                  print(f"Using workspace: {workspaces[0]['name']}")

                  # Get user's tasks across all projects
                  me = client.users.me()
                  tasks = list(client.tasks.find_by_user(me['gid'], {
                      "workspace": workspace_id,
                      "opt_fields": "name,completed,projects.name",
                      "completed_since": "now"
                  }))

                  if not tasks:
                      print("No incomplete tasks found")
                      return True, 0

                  print(f"Found {len(tasks)} incomplete tasks")

                  completed_count = 0

                  for task in tasks:
                      if not task['completed']:
                          project_names = [p['name'] for p in task.get('projects', [])]
                          project_info = f" (Projects: {', '.join(project_names)})" if project_names else ""

                          if dry_run:
                              print(f"ðŸ§ª WOULD COMPLETE: {task['name']}{project_info}")
                              completed_count += 1
                          else:
                              print(f"Completing: {task['name']}{project_info}")
                              client.tasks.update(task['gid'], {'completed': True})
                              completed_count += 1

                  print(f"\nðŸ“Š Summary:")
                  print(f"âœ… {'Would complete' if dry_run else 'Completed'}: {completed_count} tasks")
                  print(f"ðŸ”„ Bulk completion finished")

                  return True, completed_count

              except Exception as e:
                  print(f"âŒ Error in bulk completion: {str(e)}")
                  return False, 0

          if __name__ == "__main__":
              pat = "${{ secrets.ASANA_PAT }}"
              dry_run = "${{ env.DRY_RUN }}" == "true"

              if not pat:
                  print("âŒ ASANA_PAT secret not found. Please add your Asana Personal Access Token to repository secrets.")
                  sys.exit(1)

              if not dry_run:
                  print("âš ï¸  WARNING: This will complete ALL your incomplete tasks!")
                  print("Make sure this is what you want to do.")

              success, completed_count = bulk_complete_all_tasks(pat, dry_run)

              # Set outputs for GitHub Actions
              with open(os.getenv('GITHUB_OUTPUT', '/dev/stdout'), 'a') as f:
                  f.write(f"completed-count={completed_count}\n")

              sys.exit(0 if success else 1)
          EOF

          python bulk_complete_all.py

  # Job 5: Enhanced summary and notification with analytics
  notify-completion:
    needs: [complete-single-task, complete-project-tasks, complete-tasks-by-tag, bulk-complete-all]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Calculate Totals
        id: calculate-totals
        run: |
          SINGLE_COMPLETED=${{ needs.complete-single-task.outputs.completed-count || 0 }}
          PROJECT_COMPLETED=${{ needs.complete-project-tasks.outputs.completed-count || 0 }}
          PROJECT_SKIPPED=${{ needs.complete-project-tasks.outputs.skipped-count || 0 }}
          TAG_COMPLETED=${{ needs.complete-tasks-by-tag.outputs.completed-count || 0 }}
          TAG_SKIPPED=${{ needs.complete-tasks-by-tag.outputs.skipped-count || 0 }}
          BULK_COMPLETED=${{ needs.bulk-complete-all.outputs.completed-count || 0 }}

          TOTAL_COMPLETED=$((SINGLE_COMPLETED + PROJECT_COMPLETED + TAG_COMPLETED + BULK_COMPLETED))
          TOTAL_SKIPPED=$((PROJECT_SKIPPED + TAG_SKIPPED))

          echo "total-completed=$TOTAL_COMPLETED" >> $GITHUB_OUTPUT
          echo "total-skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT

      - name: Enhanced Summary Report
        run: |
          echo "## ðŸ“‹ Asana Task Completion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ env.DRY_RUN == 'true' && 'ðŸ§ª Dry Run' || 'ðŸš€ Live Run' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Action Type:** ${{ github.event.inputs.action_type }}" >> $GITHUB_STEP_SUMMARY

            if [ -n "${{ github.event.inputs.task_id }}" ]; then
              echo "**Task ID:** ${{ github.event.inputs.task_id }}" >> $GITHUB_STEP_SUMMARY
              echo "**Task Name:** ${{ needs.complete-single-task.outputs.task-name }}" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -n "${{ github.event.inputs.project_id }}" ]; then
              echo "**Project ID:** ${{ github.event.inputs.project_id }}" >> $GITHUB_STEP_SUMMARY
              echo "**Project Name:** ${{ needs.complete-project-tasks.outputs.project-name }}" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -n "${{ github.event.inputs.task_tag }}" ]; then
              echo "**Tag:** ${{ github.event.inputs.task_tag }}" >> $GITHUB_STEP_SUMMARY
            fi

            echo "**Dependency Check:** ${{ env.CHECK_DEPENDENCIES == 'true' && 'Enabled' || 'Disabled' }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "**Pull Request:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ${{ env.DRY_RUN == 'true' && 'Would Complete' || 'Completed' }}: **${{ steps.calculate-totals.outputs.total-completed }}** tasks" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ Skipped: **${{ steps.calculate-totals.outputs.total-skipped }}** tasks" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ Backups Created: ${{ env.DRY_RUN == 'true' && '0 (dry run)' || steps.calculate-totals.outputs.total-completed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.calculate-totals.outputs.total-completed }}" -gt "0" ]; then
            echo "### ðŸŽ‰ Success!" >> $GITHUB_STEP_SUMMARY
            if [ "${{ env.DRY_RUN }}" == "true" ]; then
              echo "Dry run completed successfully. No tasks were actually completed, but the workflow validated what would happen." >> $GITHUB_STEP_SUMMARY
            else
              echo "Tasks completed successfully! Check the individual job logs for detailed information about each completed task." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No Tasks Processed" >> $GITHUB_STEP_SUMMARY
            echo "No tasks were found that met the completion criteria, or all matching tasks were already completed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Asana Integration Guide](https://github.com/${{ github.repository }}/blob/main/ASANA_INTEGRATION_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository Issues](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_STEP_SUMMARY
