name: Crisis Monetization Workflow

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  monetize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Detect crisis
        id: scoring
        run: node scripts/detect-crisis.mjs
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}

      - name: Generate content bundle
        if: steps.scoring.outputs.severity_score >= 7
        run: node scripts/generate-content-bundle.mjs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Publish WordPress blog
        id: wordpress
        if: steps.scoring.outputs.severity_score >= 7
        run: node scripts/publish-wordpress.mjs
        env:
          WP_API_TOKEN: ${{ secrets.WP_API_TOKEN }}

      - name: Send MailChimp newsletter
        if: steps.scoring.outputs.severity_score >= 7
        run: node scripts/send-mailchimp.mjs
        env:
          MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
          MAILCHIMP_DC: 'us10'
          MAILCHIMP_LIST_ID: ${{ secrets.MAILCHIMP_LIST_ID }}

      - name: Schedule Reels via SocialPilot
        if: steps.scoring.outputs.severity_score >= 7
        run: node scripts/schedule-reels.mjs
        env:
          SOCIALPILOT_API_KEY: ${{ secrets.SOCIALPILOT_API_KEY }}
          INSTAGRAM_ACCOUNT_ID: ${{ secrets.INSTAGRAM_ACCOUNT_ID }}
          BLOG_POST_URL: ${{ steps.wordpress.outputs.blog_url }}

      - name: Create Grafana public dashboard
        id: grafana
        if: steps.scoring.outputs.severity_score >= 7
        run: node scripts/create-grafana-dashboard.mjs
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}

      - name: Log revenue projection
        if: steps.scoring.outputs.severity_score >= 7
        run: |
          echo "## ðŸ’° Revenue Projection" >> $GITHUB_STEP_SUMMARY
          echo "| Channel | Revenue | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| WordPress Ads + Affiliate | \$20 | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "| MailChimp Sponsorship | \$15 | âœ… Sent |" >> $GITHUB_STEP_SUMMARY
          echo "| SocialPilot Reels | \$10 | âœ… Scheduled |" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana Premium | \$5 | âœ… Live |" >> $GITHUB_STEP_SUMMARY
          echo "| **TOTAL** | **\$50** | âœ… |" >> $GITHUB_STEP_SUMMARY
