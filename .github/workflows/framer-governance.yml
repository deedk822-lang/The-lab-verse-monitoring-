name: "Framer No-Code Governance"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'components/**'
      - 'vercel.json'
      - '.github/workflows/**'
      - '.github/scripts/**'

permissions:
  contents: read

jobs:
  framer-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      # Mask secrets FIRST to prevent exposure
      - name: Mask Sensitive Variables
        run: |
          echo "::add-mask::${{ secrets.MOONSHOT_API_KEY }}"
          echo "::add-mask::${{ secrets.KIMI_API_KEY }}"
          echo "::add-mask::${{ secrets.HUBSPOT_API_KEY }}"

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a20  # v5.3.0
        with:
          python-version: '3.12'

      # Critical: Framer-specific security validation
      - name: Run Framer Security Validator
        id: framer_validator
        run: python .github/scripts/validate_framer_security.py
        continue-on-error: false

      # Install Semgrep for SAST
      - name: Install Semgrep
        run: pip install semgrep

      # Run Framer-specific Semgrep rules
      - name: Semgrep SAST Scan
        id: semgrep
        run: |
          semgrep scan \
            --config .github/semgrep/rules/framer-security.yml \
            --sarif --output semgrep-results.sarif \
            --metrics=off
        continue-on-error: true

      # Upload SARIF to GitHub Security tab (populates SAST findings)
      - name: Upload SARIF Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: framer-security

      # Generate detailed security report
      - name: Generate Security Report
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const fs = require('fs');

            // Read SARIF results
            let findings = { errors: 0, warnings: 0, info: 0 };
            try {
              const sarif = JSON.parse(fs.readFileSync('semgrep-results.sarif', 'utf8'));
              const results = sarif.runs[0].results || [];

              results.forEach(result => {
                const level = result.level || 'warning';
                if (level === 'error') findings.errors++;
                else if (level === 'warning') findings.warnings++;
                else findings.info++;
              });
            } catch (e) {
              console.log('No SARIF results found');
            }

            // Create summary
            await core.summary
              .addHeading('ðŸ›¡ï¸ Framer Security Governance Report', 2)
              .addTable([
                [{data: 'Check', header: true}, {data: 'Status', header: true}, {data: 'Findings', header: true}],
                ['SSRF Vulnerability Detection', findings.errors > 0 ? 'âŒ Issues Found' : 'âœ… Passed', String(findings.errors)],
                ['Environment Config Sync', 'âœ… Validated', '-'],
                ['Secret Masking', 'âœ… Protected', '-'],
                ['AI Data Flow', 'âœ… Connected', '-'],
                ['Semgrep SAST', findings.warnings > 0 ? 'âš ï¸  Warnings' : 'âœ… Clean', String(findings.warnings)]
              ])
              .addHeading('Dashboard Impact', 3)
              .addRaw(`
- **SAST Findings**: ${findings.errors + findings.warnings} (was 0)
- **Critical Issues**: ${findings.errors}
- **Security Score**: ${findings.errors === 0 ? 'âœ… Pass' : 'âŒ Fail'}
              `)
              .write();

            // Fail if critical errors found
            if (findings.errors > 0) {
              core.setFailed(`Found ${findings.errors} critical security issues`);
            }

  ai-cms-sync:
    needs: framer-security
    if: github.event.pull_request.head.ref == 'main' || contains(github.event.pull_request.labels.*.name, 'cms-update')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a20
        with:
          python-version: '3.12'

      - name: Mask API Keys
        run: |
          echo "::add-mask::${{ secrets.MOONSHOT_API_KEY }}"

      - name: Run AI CMS Sync
        id: ai_sync
        env:
          MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
        run: |
          python .github/scripts/kimi-cms-sync.py
          # Script must write to GITHUB_OUTPUT

      - name: Create CMS Update PR
        if: steps.ai_sync.outputs.body != ''
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.KIMI_PAT || secrets.KIMI_GITHUB_KEY || secrets.GITHUB_TOKEN }}
          commit-message: "chore: AI-generated CMS content update"
          title: "ðŸ¤– AI CMS Update"
          body: ${{ steps.ai_sync.outputs.body }}
          branch: ai-cms-sync
          labels: cms-update, automated
