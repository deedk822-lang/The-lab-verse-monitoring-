name: Jira Sync

on:
  pull_request:
    types: [opened, reopened, closed]

jobs:
  sync-jira-on-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Jira issue key from branch name
        id: extract_jira_key
        run: |
          # The branch name is available in the GITHUB_HEAD_REF environment variable
          echo "Branch name: ${{ github.head_ref }}"

          # Regex to find key like TC-123 (Change 'TC' if your project key is different)
          JIRA_KEY=$(echo "${{ github.head_ref }}" | grep -o -E 'TC-[0-9]+' | head -1)

          if [ -z "$JIRA_KEY" ]; then
            echo "Jira key not found in branch name. Skipping."
            echo "issue_key=" >> $GITHUB_OUTPUT
          else
            echo "Found Jira key: $JIRA_KEY"
            echo "issue_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          fi

      # FIX: Added Login Step (Required for gajira-transition to work)
      - name: Login to Jira
        if: steps.extract_jira_key.outputs.issue_key != ''
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Transition Jira issue to In Progress
        if: (github.event.action == 'opened' || github.event.action == 'reopened') && steps.extract_jira_key.outputs.issue_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract_jira_key.outputs.issue_key }}
          transition: "In Progress"

      - name: Transition Jira issue to Done
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.extract_jira_key.outputs.issue_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract_jira_key.outputs.issue_key }}
          transition: "Done"
