name: Jira Sync

on:
  pull_request:
    types: [opened, reopened, closed]

jobs:
  sync-jira-on-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira issue key from branch name
        id: extract_jira_key
        run: |
          # The branch name is available in the GITHUB_HEAD_REF environment variable
          # for events that originate from a pull request.
          echo "Branch name: ${{ github.head_ref }}"
          JIRA_KEY=$(echo "${{ github.head_ref }}" | grep -o -E 'TC-[0-9]+')
          if [ -z "$JIRA_KEY" ]; then
            echo "Jira key not found in branch name. Skipping."
            echo "issue_key=" >> $GITHUB_OUTPUT
          else
            echo "Found Jira key: $JIRA_KEY"
            echo "issue_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          fi

      - name: Transition Jira issue to In Progress
        # Run this step if a PR is opened or reopened, and a Jira key was found.
        if: (github.event.action == 'opened' || github.event.action == 'reopened') && steps.extract_jira_key.outputs.issue_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          # Add secrets to your repository settings for this to work.
          jira_base_url: ${{ secrets.JIRA_BASE_URL }}
          jira_user_email: ${{ secrets.JIRA_USER_EMAIL }}
          jira_api_token: ${{ secrets.JIRA_API_TOKEN }}
          issue: ${{ steps.extract_jira_key.outputs.issue_key }}
          transition: "In Progress"

      - name: Transition Jira issue to Done
        # Run this step if a PR is closed and merged, and a Jira key was found.
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.extract_jira_key.outputs.issue_key != ''
        uses: atlassian/gajira-transition@v3
        with:
          # Add secrets to your repository settings for this to work.
          jira_base_url: ${{ secrets.JIRA_BASE_URL }}
          jira_user_email: ${{ secrets.JIRA_USER_EMAIL }}
          jira_api_token: ${{ secrets.JIRA_API_TOKEN }}
          issue: ${{ steps.extract_jira_key.outputs.issue_key }}
          transition: "Done"
