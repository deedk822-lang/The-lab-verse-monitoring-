name: Jules Governance

on:
  pull_request:
    branches: [main, develop]

jobs:
  analyze_pr:
    name: ðŸ”Ž Analyze Pull Request
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} ${{ github.sha }})
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run PR Analyzer
        id: analyzer
        run: |
          if [ ! -f ".github/scripts/pr_analyzer.py" ]; then
            echo "Analyzer script missing; skipping."
            echo "analysis=Analyzer script missing; skipping." >> $GITHUB_OUTPUT
            exit 0
          fi

          ANALYSIS_OUTPUT=$(echo "${{ steps.changed-files.outputs.files }}" | python .github/scripts/pr_analyzer.py)
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post analysis comment to PR
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const output = `
            ## Jules Governance Analysis
            \`\`\`
            ${{ steps.analyzer.outputs.analysis }}
            \`\`\`
            `;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });

      - name: Do not fail PR on governance analysis
        run: |
          echo "Governance analysis completed (non-blocking)."
