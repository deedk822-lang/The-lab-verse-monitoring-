name: Jules Governance

on:
  pull_request:
    branches: [main, develop]

jobs:
  analyze_pr:
    name: ðŸ”Ž Analyze Pull Request
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Required to post comments on the PR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for accurate file comparisons

      - name: Get changed files
        id: changed-files
        run: |
          # Fetch the target branch to ensure the diff-base is available
          git fetch origin ${{ github.base_ref }}
          # Get the list of changed files between the PR branch and the target branch
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} ${{ github.sha }})
          echo "files=${CHANGED_FILES}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run PR Analyzer
        id: analyzer
        run: |
          # The script will exit with a non-zero code if the check fails
          ANALYSIS_OUTPUT=$(echo "${{ steps.changed-files.outputs.files }}" | python .github/scripts/pr_analyzer.py)
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true # Allow the workflow to continue to the commenting step

      - name: Post analysis comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
              ## Jules Governance Analysis
              \`\`\`
              ${{ steps.analyzer.outputs.analysis }}
              \`\`\`
            `;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });

      - name: Fail workflow if analysis failed
        if: steps.analyzer.outcome == 'failure'
        run: |
          echo "PR analysis failed. See the comment above for details."
          exit 1
