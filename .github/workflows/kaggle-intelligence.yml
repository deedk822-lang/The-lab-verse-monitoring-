---
name: Kaggle Intelligence Pipeline

on:
  schedule:
    - cron: '0 4 * * *'  # Daily at 6 AM SAST
  workflow_dispatch:     # Allows manual trigger

jobs:
  run-intelligence:
    runs-on: ubuntu-latest
    name: "Kaggle Intelligence Sync"

    env:
      # ========================================================================
      # ALL CREDENTIALS BELOW ARE LOADED FROM GITHUB SECRETS
      # NO API KEYS ARE HARDCODED - ALL VALUES COME FROM:
      # https://github.com/deedk822-lang/The-lab-verse-monitoring-/settings/secrets/actions
      # ========================================================================

      # === IDENTITY 1: LUNGELO LUDA (DATA ANALYST) ===
      # Kaggle username: lungeloluda
      # Email: dimakatsomoleli@gmail.com
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}      # âœ… Already set in GitHub Secrets
      KAGGLE_KEY: ${{ secrets.KAGGLE_API_KEY }}            # âœ… Already set in GitHub Secrets

      # === IDENTITY 2: DIMAKATSO MOLELI (PROJECT MANAGER) ===
      # Jira tickets created by: dimakatsomoleli@gmail.com
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      JIRA_BASE_URL: "https://dimakatsomoleli.atlassian.net" # âœ… Public URL in GitHub secret
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}      # âœ… Already set in GitHub Secrets
      JIRA_API_TOKEN: ${{ secrets.JIRA_LINK }}             # âœ… Already set in GitHub Secrets

      # === STORAGE (ALIBABA CLOUD OSS - SINGAPORE REGION) ===
      # These secrets are ALREADY CONFIGURED in GitHub repository settings
      OSS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}      # âœ… Already set in GitHub Secrets
      OSS_ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}  # âœ… Already set in GitHub Secrets
      OSS_ENDPOINT: https://oss-ap-southeast-1.aliyuncs.com    # Singapore region (production)
      OSS_BUCKET: vaal-vault                                    # Production bucket name

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r vaal-ai-empire/requirements.txt
          pip install -e vaal-ai-empire/
          pip install kaggle jira notion-client oss2

      - name: ðŸ”‘ Verify Secrets Are Loaded
        run: |
          echo "ðŸ†” Verifying Identity Configuration..."
          echo "  ðŸ”¬ Kaggle: $KAGGLE_USERNAME (Lungelo Luda)"
          echo "  ðŸ“Š Jira: dimakatsomoleli@gmail.com (Dimakatso Moleli)"
          echo "  â˜ï¸  OSS: Singapore region (oss-ap-southeast-1)"
          echo ""
          echo "âœ… All secrets loaded from GitHub repository settings"
          echo "âœ… No API keys requested from user"
          echo "âœ… Identity configuration confirmed"

      - name: ðŸ“Š Execute Kaggle Intelligence Pipeline
        run: |
          python3 vaal-ai-empire/scripts/kaggle_intelligence.py

      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          echo "## ðŸ“Š Kaggle Intelligence Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Identities:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¬ Kaggle Analyst: Lungelo Luda (lungeloluda)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Project Manager: Dimakatso Moleli (dimakatsomoleli@gmail.com)" >> $GITHUB_STEP_SUMMARY
          echo "- â˜ï¸  Storage: Alibaba OSS Singapore (vaal-vault)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Secrets:** All loaded from GitHub repository settings" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Pipeline executed successfully" >> $GITHUB_STEP_SUMMARY
