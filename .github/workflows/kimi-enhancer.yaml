name: ğŸ¤– Kimi AI Enhancer + Security Validator

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for the agent (e.g., "Improve CI integrity")'
        required: true
        default: 'Analyze and improve codebase'
      mode:
        description: 'Execution mode'
        type: choice
        options:
          - 'create-pr'
          - 'direct-commit'
        default: 'create-pr'
      branch_name:
        description: 'Branch name for PR (auto-generated if empty)'
        required: false
        default: 'kimi-enhancement'
      install_ollama:
        description: 'Install and start Ollama (no placeholder config committed)'
        type: boolean
        default: true
      ollama_model:
        description: 'Model to pull (optional); leave empty to skip pull'
        required: false
        default: ''
      run_security_scan:
        description: 'Run security scan before PR'
        type: boolean
        default: true
      run_tests:
        description: 'Run test suite before PR'
        type: boolean
        default: true
      auto_fix_issues:
        description: 'Auto-fix formatting and minor issues'
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.10'
  KIMI_CONTEXT_FILE: '.github/kimi-context.yaml'

permissions:
  contents: write
  pull-requests: write

jobs:
  enhance:
    name: Enhancement
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      branch_name: ${{ steps.branch.outputs.name }}
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Python tooling
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 pytest

      - name: ğŸ¦™ Install & start Ollama
        if: github.event.inputs.install_ollama == 'true'
        run: |
          set -euo pipefail
          curl -fsSL https://ollama.com/install.sh | sudo -E sh
          ollama --version

          nohup ollama serve > ollama.log 2>&1 &
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
              echo "âœ… Ollama is running"
              break
            fi
            sleep 1
          done

          if [ -n "${{ github.event.inputs.ollama_model }}" ]; then
            echo "Pulling model: ${{ github.event.inputs.ollama_model }}"
            ollama pull "${{ github.event.inputs.ollama_model }}"
          else
            echo "No ollama_model provided; skipping pull"
          fi

      - name: ğŸ” Configure Git
        run: |
          git config --global user.name "Kimi AI Bot"
          git config --global user.email "kimi-ai@vaal-empire.bot"

      - name: ğŸŒ¿ Create working branch
        id: branch
        run: |
          set -euo pipefail
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="${{ github.event.inputs.branch_name }}-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ§¾ Record requested task
        run: |
          printf "%s\n" "Task: ${{ github.event.inputs.task }}" > .github/last-agent-task.txt

      - name: ğŸ” Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --cached --stat
          fi

      - name: ğŸ¨ Auto-fix formatting
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.auto_fix_issues == 'true'
        continue-on-error: true
        run: |
          black .
          isort .
          git add -A

      - name: ğŸ’¾ Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git commit -m "chore: ${{ github.event.inputs.task }}" \
            -m "Workflow: ${{ github.run_id }}" \
            -m "By: @${{ github.actor }}"

      - name: ğŸš€ Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.name }}

      - name: ğŸ“¤ Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.mode == 'create-pr'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          title: "ğŸ¤– Agent: ${{ github.event.inputs.task }}"
          body: |
            ## ğŸ¤– Automated Enhancement

            **Task:** ${{ github.event.inputs.task }}
            **Triggered by:** @${{ github.actor }}
            **Workflow:** [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Notes:
            - No placeholder config committed
            - Failures are not masked
          labels: |
            automated
            kimi-ai
          assignees: ${{ github.actor }}

  security-scan:
    name: Security Validation
    needs: enhance
    if: needs.enhance.outputs.has_changes == 'true' && github.event.inputs.run_security_scan == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.enhance.outputs.branch_name }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ”’ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: ğŸ›¡ï¸ Run Safety check
        run: |
          safety check

      - name: ğŸ” Run Bandit
        run: |
          bandit -r src/pr_fix_agent -ll

  test-suite:
    name: Run Tests
    needs: enhance
    if: needs.enhance.outputs.has_changes == 'true' && github.event.inputs.run_tests == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.enhance.outputs.branch_name }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -e .

      - name: ğŸ§ª Run tests
        run: |
          pytest -v --cov=src --cov-report=term-missing
