name: ğŸ¤– Kimi AI Enhancer

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Kimi (e.g., "Implement comprehensive security package")'
        required: true
        default: 'Analyze and improve codebase'
      mode:
        description: 'Execution mode'
        type: choice
        options:
          - 'create-pr'
          - 'direct-commit'
        default: 'create-pr'
      branch_name:
        description: 'Branch name for PR (auto-generated if empty)'
        required: false
        default: 'kimi-enhancement'

jobs:
  enhance:
    runs-on: ubuntu-latest
    # No permissions needed when using PAT - token has its own permissions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.KIMI_PAT }}  # Use your PAT here
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Kimi CLI
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        run: |
          curl -LsSf https://cdn.kimi.com/binaries/kimi-cli/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          kimi config set-key "$KIMI_API_KEY"
          kimi --version

      - name: Configure Git with PAT
        run: |
          git config --global user.name "Kimi AI"
          git config --global user.email "kimi-ai@github-actions"
          # Configure git to use PAT for pushing
          git remote set-url origin https://x-access-token:${{ secrets.KIMI_PAT }}@github.com/${{ github.repository }}.git

      - name: Create working branch
        id: branch
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch_name }}-$(date +%s)"
          git checkout -b $BRANCH_NAME
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Execute Kimi Task
        id: kimi
        run: |
          cat > /tmp/task.txt << 'EOF'
          ${{ github.event.inputs.task }}

          You are working in a GitHub Actions environment with full repository access.
          You can:
          1. Read and write files in the repository using WriteFile and StrReplaceFile tools
          2. Execute shell commands using the Shell tool
          3. Use git commands to commit changes

          Please implement the requested changes and verify they work correctly.
          EOF

          kimi --print --yolo -c "$(cat /tmp/task.txt)" > /tmp/kimi_output.txt 2>&1
          cat /tmp/kimi_output.txt

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected by Kimi"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            git diff --cached --stat
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git commit -m "ğŸ¤– Kimi AI: ${{ github.event.inputs.task }}

          Automated enhancement performed by Kimi CLI
          Task: ${{ github.event.inputs.task }}
          Workflow Run: ${{ github.run_id }}
          Actor: ${{ github.actor }}"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.name }}
          echo "Pushed to branch: ${{ steps.branch.outputs.name }}"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.mode == 'create-pr'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.KIMI_PAT }}  # Use PAT here too
          branch: ${{ steps.branch.outputs.name }}
          base: main
          title: "ğŸ¤– Kimi AI Enhancement: ${{ github.event.inputs.task }}"
          body: |
            ## ğŸ¤– Automated Enhancement by Kimi AI

            **Task:** ${{ github.event.inputs.task }}

            **Changes Summary:**
            This PR contains automated code improvements generated by Kimi CLI.

            **Files Modified:**
            See the diff below for details.

            **Action Required:**
            - [ ] Review code changes
            - [ ] Run tests to verify functionality
            - [ ] Approve and merge if satisfactory

            ---
            *This PR was automatically generated by Kimi CLI via GitHub Actions*
          labels: automated, enhancement, kimi-ai
          draft: false

      - name: Direct Commit to Main
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.mode == 'direct-commit'
        run: |
          git checkout main
          git merge --no-ff ${{ steps.branch.outputs.name }} -m "Merge Kimi AI changes from ${{ steps.branch.outputs.name }}"
          git push origin main
          echo "Committed directly to main branch"

      - name: Report Status
        if: always()
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Kimi successfully enhanced the repository"
            if [ "${{ github.event.inputs.mode }}" == "create-pr" ]; then
              echo "ğŸ”— Pull Request created from branch: ${{ steps.branch.outputs.name }}"
            else
              echo "ğŸ“ Changes committed directly to main"
            fi
          else
            echo "â„¹ï¸ No changes were made (Kimi may have analyzed but not modified files)"
          fi
