name: LLM Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  collect-findings:
    name: Collect Findings
    runs-on: ubuntu-latest
    outputs:
      findings_file: ${{ steps.collect.outputs.findings_file }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Collect findings
        id: collect
        run: |
          mkdir -p artifacts
          # Run static analysis tools and collect findings
          echo '{"findings": []}' > artifacts/findings.json
          echo "findings_file=artifacts/findings.json" >> $GITHUB_OUTPUT

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: findings
          path: artifacts/findings.json

  reasoning-and-coding:
    name: Reasoning and Coding Analysis
    runs-on: ubuntu-latest
    needs: [collect-findings]
    outputs:
      proposals_file: ${{ steps.reason.outputs.proposals_file }}

    steps:
      - uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /etc/mysql
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker image prune -af

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 10
          ollama pull deepseek-r1:1.5b
          ollama pull qwen2.5-coder:1.5b

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download findings
        uses: actions/download-artifact@v4
        with:
          name: findings
          path: artifacts

      - name: Run reasoning analysis
        id: reason
        run: |
          pr-fix-agent --mode reasoning \
            --findings artifacts/findings.json \
            --output artifacts/proposals.json
          echo "proposals_file=artifacts/proposals.json" >> $GITHUB_OUTPUT

      - name: Generate code fixes
        run: |
          pr-fix-agent --mode coding \
            --proposals artifacts/proposals.json \
            --output artifacts/fixes \
            --apply

      - name: Upload proposals
        uses: actions/upload-artifact@v4
        with:
          name: proposals
          path: artifacts/proposals.json

      - name: Upload fixes
        uses: actions/upload-artifact@v4
        with:
          name: fixes
          path: artifacts/fixes

  test-verification:
    name: Test Verification
    runs-on: ubuntu-latest
    needs: [reasoning-and-coding]
    outputs:
      tests_passed: ${{ steps.test.outputs.tests_passed }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Download fixes
        uses: actions/download-artifact@v4
        with:
          name: fixes
          path: artifacts/fixes

      - name: Run tests
        id: test
        run: |
          pytest tests/ --json-report --json-report-file=artifacts/test-results.json || true
          if [ -f artifacts/test-results.json ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: artifacts/test-results.json

  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: [test-verification]
    if: needs.test-verification.outputs.tests_passed == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '{proposals,test-results}'
          path: artifacts
          merge-multiple: true

      - name: Generate PR body
        run: |
          pr-fix-agent --mode generate-pr \
            --proposals artifacts/proposals.json \
            --test-results artifacts/test-results.json \
            --output pr-body.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Auto-fix: Code review findings"
          title: "ðŸ¤– Auto-fix: Code review findings"
          body-path: pr-body.md
          branch: auto-fix/code-review-${{ github.run_number }}
          labels: |
            automated-fix
            code-review
            llm-generated
          draft: false
          delete-branch: true

  report-summary:
    name: Report Summary
    runs-on: ubuntu-latest
    needs: [collect-findings, reasoning-and-coding, test-verification, create-pr]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ¤– LLM Code Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Findings Collected**: ${{ needs.collect-findings.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reasoning & Coding**: ${{ needs.reasoning-and-coding.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test-verification.outputs.tests_passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Created**: ${{ needs.create-pr.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
