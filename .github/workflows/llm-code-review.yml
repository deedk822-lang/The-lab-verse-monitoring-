name: LLM-Powered Code Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ========================================================================
  # STEP 1: Collect Code Review Findings
  # ========================================================================

  collect-findings:
    name: Collect Code Review Findings
    runs-on: ubuntu-latest
    outputs:
      findings_file: ${{ steps.collect.outputs.findings_file }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          pip install bandit ruff mypy safety
          pip install -e .

      - name: Run static analysis
        id: collect
        run: |
          mkdir -p analysis-results

          # Bandit (security)
          bandit -r src/ -f json -o analysis-results/bandit.json || true

          # Ruff (linting)
          ruff check src/ --output-format=json > analysis-results/ruff.json || true

          # MyPy (type checking)
          mypy src/ --json-report analysis-results/mypy.json || true

          # Safety (dependencies)
          safety check --json > analysis-results/safety.json || true

          echo "findings_file=analysis-results" >> $GITHUB_OUTPUT

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: analysis-results/

  # ========================================================================
  # STEP 2: Install Ollama and Models
  # ========================================================================

  setup-ollama:
    name: Setup Ollama
    runs-on: ubuntu-latest
    needs: [collect-findings]

    steps:
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5

      - name: Pull reasoning model
        run: |
          ollama pull deepseek-r1:14b

      - name: Pull coding model
        run: |
          ollama pull qwen2.5-coder:32b

      - name: Verify models
        run: |
          ollama list

  # ========================================================================
  # STEP 3: Reasoning Model Analysis
  # ========================================================================

  reasoning-analysis:
    name: Reasoning Model Analysis
    runs-on: ubuntu-latest
    needs: [collect-findings, setup-ollama]
    outputs:
      proposals_file: ${{ steps.reason.outputs.proposals_file }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package
        run: |
          pip install -e .
          pip install structlog openlit

      - name: Download findings
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
          path: analysis-results/

      - name: Run reasoning model
        id: reason
        run: |
          python -m pr_fix_agent.orchestrator \
            --mode reasoning \
            --findings analysis-results/ \
            --output proposals.json \
            --model deepseek-r1:14b

          echo "proposals_file=proposals.json" >> $GITHUB_OUTPUT

      - name: Upload proposals
        uses: actions/upload-artifact@v4
        with:
          name: fix-proposals
          path: proposals.json

  # ========================================================================
  # STEP 4: Coding Model Implementation
  # ========================================================================

  coding-implementation:
    name: Coding Model Implementation
    runs-on: ubuntu-latest
    needs: [reasoning-analysis]
    outputs:
      fixes_applied: ${{ steps.code.outputs.fixes_applied }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package
        run: |
          pip install -e .

      - name: Download proposals
        uses: actions/download-artifact@v4
        with:
          name: fix-proposals
          path: ./

      - name: Run coding model
        id: code
        run: |
          python -m pr_fix_agent.orchestrator \
            --mode coding \
            --proposals proposals.json \
            --output fixes/ \
            --model qwen2.5-coder:32b \
            --apply

          echo "fixes_applied=true" >> $GITHUB_OUTPUT

      - name: Upload fixed code
        uses: actions/upload-artifact@v4
        with:
          name: fixed-code
          path: src/

  # ========================================================================
  # STEP 5: Test Verification
  # ========================================================================

  test-verification:
    name: Test Verification
    runs-on: ubuntu-latest
    needs: [coding-implementation]
    outputs:
      tests_passed: ${{ steps.test.outputs.tests_passed }}

    steps:
      - uses: actions/checkout@v4

      - name: Download fixed code
        uses: actions/download-artifact@v4
        with:
          name: fixed-code
          path: src/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"

      - name: Run tests
        id: test
        run: |
          if pytest tests_real/ -v --tb=short --json-report --json-report-file=test-results.json; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.json

  # ========================================================================
  # STEP 6: Create Pull Request
  # ========================================================================

  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: [test-verification]
    if: needs.test-verification.outputs.tests_passed == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Download fixed code
        uses: actions/download-artifact@v4
        with:
          name: fixed-code
          path: src/

      - name: Download proposals
        uses: actions/download-artifact@v4
        with:
          name: fix-proposals
          path: ./

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: ./

      - name: Generate PR body
        id: pr-body
        run: |
          python -m pr_fix_agent.orchestrator \
            --mode generate-pr \
            --proposals proposals.json \
            --test-results test-results.json \
            --output pr-body.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Auto-fix: Code review findings"
          title: "ðŸ¤– Auto-fix: Code review findings"
          body-path: pr-body.md
          branch: auto-fix/code-review-${{ github.run_number }}
          labels: |
            automated-fix
            code-review
            llm-generated
          draft: false
          delete-branch: true

  # ========================================================================
  # STEP 7: Report Summary
  # ========================================================================

  report-summary:
    name: Report Summary
    runs-on: ubuntu-latest
    needs: [create-pr]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ¤– LLM Code Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Findings Collected**: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Reasoning Analysis**: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Implementation**: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test-verification.outputs.tests_passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Created**: ${{ needs.create-pr.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
