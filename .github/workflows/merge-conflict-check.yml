name: Merge Conflict Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflict markers
        run: |
          echo "ğŸ” Scanning for merge conflict markers..."
          
          # Search for common merge conflict markers
          CONFLICT_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs grep -l "^<<<<<<< \|^======= \|^>>>>>>> " 2>/dev/null || true)
          
          if [ -n "$CONFLICT_FILES" ]; then
            echo "âŒ Merge conflict markers found in:"
            echo "$CONFLICT_FILES"
            echo ""
            echo "Please resolve these conflicts before merging:"
            echo "$CONFLICT_FILES" | while read file; do
              echo ""
              echo "File: $file"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              grep -n "^<<<<<<< \|^======= \|^>>>>>>> " "$file" || true
            done
            exit 1
          fi
          
          echo "âœ… No merge conflict markers found"

      - name: Check for duplicate package.json keys
        run: |
          echo "ğŸ” Checking for duplicate keys in package.json..."
          python3 scripts/check_duplicate_keys.py

      - name: Validate JSON syntax
        run: |
          echo "ğŸ” Validating all JSON files syntax..."
          
          JSON_FILES=$(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.next/*" -not -path "*/dist/*")
          
          INVALID_COUNT=0
          for file in $JSON_FILES; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON: $file"
              INVALID_COUNT=$((INVALID_COUNT + 1))
            fi
          done
          
          if [ $INVALID_COUNT -gt 0 ]; then
            echo ""
            echo "âŒ Found $INVALID_COUNT invalid JSON file(s)"
            exit 1
          fi
          
          echo "âœ… All JSON files have valid syntax"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALL MERGE CONFLICT CHECKS PASSED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This PR is safe to merge - no conflicts detected!"
