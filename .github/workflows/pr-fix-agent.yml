name: ðŸ¤– PR Fix Agent (Codespace Optimized)

on:
  workflow_run:
    workflows: ["LLM-Powered Code Review (FIXED)"]
    types:
      - completed

jobs:
  fix-and-propose:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # âœ… FIX: Install Ollama with proper setup
      - name: ðŸ¦™ Setup Ollama
        run: |
          # Install Ollama
          curl -fsSL https://ollama.com/install.sh | sh

          # Start service
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 5

          # Pull lightweight models
          ollama pull deepseek-r1:1.5b &
          ollama pull qwen2.5-coder:1.5b &
          wait

          echo "âœ… Ollama ready"

      # âœ… FIX: Install dependencies properly
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install ollama
          # Create minimal structure if not exists
          mkdir -p src/pr_fix_agent

      # âœ… FIX: Run with timeout protection
      - name: ðŸ¤– Run PR Fix Agent
        timeout-minutes: 15  # Overall job timeout
        run: |
          # Download findings from previous workflow
          gh run download ${{ github.event.workflow_run.id }} -n analysis-results || true

          # Create analysis-results directory if download failed
          mkdir -p analysis-results

          # Run orchestrator with limited scope
          python src/pr_fix_agent/orchestrator.py review \
            --findings analysis-results/safety.json \
            --limit 5  # âœ… FIX: Limit to 5 to prevent timeout

      - name: ðŸ’¾ Upload proposals
        uses: actions/upload-artifact@v4
        with:
          name: fix-proposals
          path: proposals.json
