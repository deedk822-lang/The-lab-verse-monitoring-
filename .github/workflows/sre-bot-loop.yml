name: "SRE Autonomous Fix Loop"

on:
  issue_comment:
    types: [created]
  push:
    branches: ["main", "develop"]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  sre-gatekeeper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Config-Code Validator
        id: validator
        run: python .github/scripts/validate_config_sync.py

      - name: Trigger Jules Remediation on Comment
        if: |
          github.event_name == 'issue_comment' &&
          contains(github.event.comment.body, '#FIX-REQUIRED') &&
          (github.event.comment.user.login == 'coderabbitai[bot]' || github.event.comment.user.login == 'coderabbitai')
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `
            @google-labs-jules

            ### ðŸ¤– SRE Automation Trigger (ARCHITECTURE MODE)
            The pipeline has detected **Configuration Drift** or a **Critical Review Finding**.

            **Mission Objectives:**
            1. **Analyze Failure:** Review the output of the 'Run Config-Code Validator' step above or the CodeRabbit comment that triggered this workflow.
            2. **Synchronize Configuration:** Purge "Ghost Variables" (e.g., AIRTABLE_BASE_ID) from vercel.json and ensure all variables in talent_scout.py are defined in the config.
            3. **Adhere to Architecture:**
               - Ensure all exceptions are imported from \`talent_scout_exceptions.py\`.
               - Replace any \`raise Error("String")\` with typed exceptions like \`raise ConfigurationError("...")\`.
            4. **Push Fixes:** Commit the architectural fixes directly to this branch.
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
