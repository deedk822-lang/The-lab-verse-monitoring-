name: "SRE Autonomous Fix Loop"

on:
  issue_comment:
    types: [created]
  # Also run on push to catch the config drift immediately
  push:
    branches: ["main", "develop"]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  # NEW JOB: The Gatekeeper
  config-sync-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Config-Code Validator
        run: python .github/scripts/validate_config_sync.py
      # If this fails, we proceed to the fixer below

  summon-jules:
    if: |
      contains(github.event.comment.body, '#FIX-REQUIRED') &&
      (github.event.comment.user.login == 'coderabbitai[bot]' || github.event.comment.user.login == 'coderabbitai')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Jules Remediation
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `
            @google-labs-jules

            ### ðŸ¤– SRE Automation Trigger (ARCHITECTURE MODE)
            The pipeline has detected **Configuration Drift** and **Linting Violations (TRY003)**.

            **Mission Objectives:**
            1. **Config Sync:** Purge "Ghost Variables" (AIRTABLE_BASE_ID) from vercel.json.
            2. **Architecture Upgrade:**
               - Import exceptions from the new \`talent_scout_exceptions.py\`.
               - Replace \`raise Error("String")\` with \`raise ConfigurationError("String")\`.
            3. **Code Hygiene:** Ensure all imports are clean and the build passes.

            Please push the architectural fixes to this branch.
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
