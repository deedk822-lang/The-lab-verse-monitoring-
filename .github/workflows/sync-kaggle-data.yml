name: Sync Strategic Kaggle Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # Run every Monday at midnight

jobs:
  data-intelligence:
    runs-on: ubuntu-latest
    name: "Kaggle Intelligence Sync"

    env:
      # KAGGLE IDENTITY
      KAGGLE_USERNAME: "lungeloluda"
      KAGGLE_KEY: ${{ secrets.KAGGLE_API_TOKEN }}

      # JIRA IDENTITY
      JIRA_BASE_URL: "https://dimakatsomoleli.atlassian.net"
      JIRA_USER_EMAIL: ${{ secrets.USER_LOGON_NAME }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_LINK }}

      # ALIBABA CLOUD
      OSS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
      OSS_ENDPOINT: https://oss-eu-west-1.aliyuncs.com
      OSS_BUCKET: vaal-vault

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r vaal-ai-empire/requirements.txt
          pip install -e vaal-ai-empire/
          pip install kaggle jira notion-client oss2

      - name: ðŸ” Configure Kaggle Auth
        run: |
          # We manually build the auth file using the env vars above
          mkdir -p ~/.kaggle
          echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: ðŸ“Š Execute Kaggle Sync
        run: |
          python3 vaal-ai-empire/scripts/kaggle_intelligence.py

      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## Kaggle Intelligence Report ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "Sync executed for user: $KAGGLE_USERNAME" >> $GITHUB_STEP_SUMMARY
