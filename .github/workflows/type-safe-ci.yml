name: üîí Type-Safe CI/CD Pipeline
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  ALIYUN_REGION: cn-shanghai
  ACCESS_ANALYZER_ARN: acs:accessanalyzer:cn-shanghai:5212459344287865:analyzer/prod_security_analyzer
  # Pin CLI version to reduce supply-chain risk of downloading "latest".
  ALIYUN_CLI_VERSION: 3.0.277

jobs:
  type-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r rainmaker_orchestrator/requirements.txt
          pip install mypy

      - name: Run MyPy type checking
        run: |
          python -m mypy --strict --package rainmaker_orchestrator

  security-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine if security analysis can run
        id: gate
        env:
          ALIYUN_ROLE_ARN: ${{ secrets.ALIYUN_ROLE_ARN }}
          ALIYUN_OIDC_PROVIDER_ARN: ${{ secrets.ALIYUN_OIDC_PROVIDER_ARN }}
        run: |
          if [ -z "$ALIYUN_ROLE_ARN" ] || [ -z "$ALIYUN_OIDC_PROVIDER_ARN" ]; then
            echo "can_run=false" >> $GITHUB_OUTPUT
            echo "Alibaba Cloud OIDC secrets not configured; skipping security analysis for PR."
          else
            echo "can_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Install jq
        if: steps.gate.outputs.can_run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Alibaba Cloud CLI
        if: steps.gate.outputs.can_run == 'true'
        run: |
          # Pin to specific version for supply chain security
          CLI_VERSION="3.0.198"
          curl -sSL "https://aliyuncli.alicdn.com/aliyun-cli-linux-${CLI_VERSION}-amd64.tgz" -o aliyun.tgz

          # Verify download succeeded
          if [ ! -f aliyun.tgz ]; then
            echo "Failed to download Alibaba Cloud CLI"
            exit 1
          fi

          # Extract and install
          tar -xzf aliyun.tgz
          sudo mv aliyun /usr/local/bin/aliyun

          # Verify installation
          aliyun version

          # Clean up
          rm aliyun.tgz

      - name: Configure Alibaba Cloud OIDC
        if: steps.gate.outputs.can_run == 'true'
        uses: aliyun/alibabacloud-auth-action@v1
        with:
          role-arn: ${{ secrets.ALIYUN_ROLE_ARN }}
          oidc-provider-arn: ${{ secrets.ALIYUN_OIDC_PROVIDER_ARN }}
          region-id: ${{ env.ALIYUN_REGION }}

      - name: Run Alibaba Cloud Access Analyzer
        if: steps.gate.outputs.can_run == 'true'
        id: security_analysis
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          else
            BASE_REF=$(git rev-parse HEAD~1)
            HEAD_REF=$(git rev-parse HEAD)
          fi

          CHANGED_FILES=$(git diff --name-only $BASE_REF $HEAD_REF | grep -E 'rainmaker_orchestrator|scripts|.github/workflows' || true)

          cat > security_report.json <<EOF
          {
            "scan_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "pull_request": "${{ github.event.number || 'N/A' }}",
            "analyzer": "${{ env.ACCESS_ANALYZER_ARN }}",
            "changed_files": $(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(. != ""))'),
            "security_findings": [],
            "observability_trace_id": "$(openssl rand -hex 16)"
          }
          EOF

          echo "üîç Running Alibaba Cloud Access Analyzer..."

          if [ -n "$CHANGED_FILES" ]; then
            aliyun accessanalyzer start-resource-scan \
              --analyzer-arn "${{ env.ACCESS_ANALYZER_ARN }}" \
              --resource-owner-account-id "5212459344287865" \
              --resource-type "ECS" \
              --output json > analyzer_results.json 2>&1 || echo "Scan completed"
          fi

          mkdir -p security-reports
          mv security_report.json security-reports/
          echo "report_path=security-reports/security_report.json" >> $GITHUB_OUTPUT

      - name: Upload Security Report
        if: steps.gate.outputs.can_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report
          path: security-reports/security_report.json

      - name: Block Merge on Critical Findings
        if: steps.gate.outputs.can_run == 'true'
        run: |
          CRITICAL_COUNT=$(jq '.security_findings | map(select(.severity == "CRITICAL")) | length' security-reports/security_report.json 2>/dev/null || echo 0)
          HIGH_COUNT=$(jq '.security_findings | map(select(.severity == "HIGH")) | length' security-reports/security_report.json 2>/dev/null || echo 0)

          echo "Critical findings: $CRITICAL_COUNT"
          echo "High findings: $HIGH_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 2 ]; then
            echo "‚ùå SECURITY VULNERABILITIES FOUND - BLOCKING MERGE"
            exit 1
          fi

          echo "‚úÖ Security analysis passed - proceeding with pipeline"

      - name: Skip notice
        if: steps.gate.outputs.can_run != 'true'
        run: |
          echo "Security analysis skipped because required Alibaba Cloud secrets are not configured for this repo/PR context."

  build-and-deploy:
    if: github.event_name == 'push'
    needs: [type-check, security-analysis]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Alibaba Cloud OIDC
        uses: aliyun/alibabacloud-auth-action@v1
        with:
          role-arn: ${{ secrets.ALIYUN_ROLE_ARN }}
          oidc-provider-arn: ${{ secrets.ALIYUN_OIDC_PROVIDER_ARN }}
          region-id: ${{ env.ALIYUN_REGION }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: rainmaker_orchestrator
          file: rainmaker_orchestrator/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Alibaba Cloud ECS
        run: |
          echo "üöÄ Deploying to Alibaba Cloud ECS with secure authentication..."

          aliyun ecs run-command \
            --instance-id "${{ secrets.ECS_INSTANCE_ID }}" \
            --region "${{ env.ALIYUN_REGION }}" \
            --command-content "cd /app/The-lab-verse-monitoring- && docker pull ghcr.io/${{ github.repository }}:${{ github.sha }} && docker-compose -f docker/compose/docker-compose.prod.yml up -d" \
            --timeout 600 \
            --name "deploy-$(date +%Y%m%d-%H%M%S)"

      - name: Verify Deployment Health
        run: |
          echo "‚úÖ Verifying deployment health..."

          for i in {1..15}; do
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.ECS_HOST }}:8000/health)

            if [ "$HEALTH_STATUS" == "200" ]; then
              echo "‚úÖ Application is healthy"
              exit 0
            fi

            echo "‚è≥ Waiting for application to become healthy... ($i/15)"
            sleep 10
          done

          echo "‚ùå Application did not become healthy within timeout period"
          exit 1

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "üîÑ Initiating secure rollback to previous version..."

          aliyun ecs run-command \
            --instance-id "${{ secrets.ECS_INSTANCE_ID }}" \
            --region "${{ env.ALIYUN_REGION }}" \
            --command-content "cd /app/The-lab-verse-monitoring- && docker pull ghcr.io/${{ github.repository }}:${{ github.event.before }} && docker-compose -f docker/compose/docker-compose.prod.yml up -d" \
            --timeout 600
