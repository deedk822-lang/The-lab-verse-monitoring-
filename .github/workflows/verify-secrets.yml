name: Verify Secrets Configuration

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/**'

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    name: Verify Required Secrets
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Verify Core API Secrets
        run: |
          echo "ðŸ” Verifying Core API Secrets..."
          
          # Check if secrets are configured (will be empty if not set)
          [ -n "${{ secrets.NOTION_API_KEY }}" ] && echo "âœ… NOTION_API_KEY configured" || echo "âŒ NOTION_API_KEY missing"
          [ -n "${{ secrets.MISTRAL_API_KEY }}" ] && echo "âœ… MISTRAL_API_KEY configured" || echo "âŒ MISTRAL_API_KEY missing"
          [ -n "${{ secrets.GROQ_API_KEY }}" ] && echo "âœ… GROQ_API_KEY configured" || echo "âŒ GROQ_API_KEY missing"
          [ -n "${{ secrets.GEMINI_API_KEY }}" ] && echo "âœ… GEMINI_API_KEY configured" || echo "âŒ GEMINI_API_KEY missing"
          [ -n "${{ secrets.BRIA_API_KEY }}" ] && echo "âœ… BRIA_API_KEY configured" || echo "âŒ BRIA_API_KEY missing"
          [ -n "${{ secrets.HF_API_TOKEN }}" ] && echo "âœ… HF_API_TOKEN configured" || echo "âŒ HF_API_TOKEN missing"
      
      - name: Verify Cloud Infrastructure Secrets
        run: |
          echo ""
          echo "â˜ï¸ Verifying Cloud Infrastructure Secrets..."
          
          [ -n "${{ secrets.ALIBABA_ACCESS_KEY_ID }}" ] && echo "âœ… ALIBABA_ACCESS_KEY_ID configured" || echo "âŒ ALIBABA_ACCESS_KEY_ID missing"
          [ -n "${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}" ] && echo "âœ… ALIBABA_ACCESS_KEY_SECRET configured" || echo "âŒ ALIBABA_ACCESS_KEY_SECRET missing"
          [ -n "${{ secrets.VERCEL_TOKEN }}" ] && echo "âœ… VERCEL_TOKEN configured" || echo "âŒ VERCEL_TOKEN missing"
      
      - name: Verify Marketing & Distribution Secrets
        run: |
          echo ""
          echo "ðŸ“¢ Verifying Marketing & Distribution Secrets..."
          
          [ -n "${{ secrets.AYRSHARE_API_KEY }}" ] && echo "âœ… AYRSHARE_API_KEY configured" || echo "âš ï¸  AYRSHARE_API_KEY missing (optional)"
          [ -n "${{ secrets.MAILCHIMP_API_KEY }}" ] && echo "âœ… MAILCHIMP_API_KEY configured" || echo "âš ï¸  MAILCHIMP_API_KEY missing (optional)"
          [ -n "${{ secrets.GOOGLE_ADS_API_KEY }}" ] && echo "âœ… GOOGLE_ADS_API_KEY configured" || echo "âš ï¸  GOOGLE_ADS_API_KEY missing (optional)"
          [ -n "${{ secrets.BRAVE_ADS_API_KEY }}" ] && echo "âœ… BRAVE_ADS_API_KEY configured" || echo "âš ï¸  BRAVE_ADS_API_KEY missing (optional)"
      
      - name: Verify Project Management Secrets
        run: |
          echo ""
          echo "ðŸ“Š Verifying Project Management Secrets..."
          
          [ -n "${{ secrets.GRAFANA_TOKEN }}" ] && echo "âœ… GRAFANA_TOKEN configured" || echo "âš ï¸  GRAFANA_TOKEN missing (optional)"
          [ -n "${{ secrets.ASANA_TOKEN }}" ] && echo "âœ… ASANA_TOKEN configured" || echo "âš ï¸  ASANA_TOKEN missing (optional)"
          [ -n "${{ secrets.ASANA_WORKSPACE_ID }}" ] && echo "âœ… ASANA_WORKSPACE_ID configured" || echo "âš ï¸  ASANA_WORKSPACE_ID missing (optional)"
      
      - name: Scan for Hardcoded Secrets
        run: |
          echo ""
          echo "ðŸ”’ Scanning for hardcoded secrets in workflows..."
          
          # Check for potential API keys
          if grep -r -E "(api[_-]?key|secret|token|password).*=.*['\"].*['\"]" .github/workflows/ --exclude="verify-secrets.yml" --exclude="*.md"; then
            echo "âš ï¸  WARNING: Found potential hardcoded secrets!"
            echo "Please review the above matches and ensure they use GitHub Secrets."
          else
            echo "âœ… No hardcoded secrets pattern found"
          fi
          
          # Check for hardcoded URLs with tokens
          if grep -r -E "https?://[^\s]*\?.*token=[a-zA-Z0-9]" .github/workflows/ --exclude="verify-secrets.yml" --exclude="*.md"; then
            echo "âš ï¸  WARNING: Found URLs with potential tokens!"
          else
            echo "âœ… No URLs with tokens found"
          fi
          
          # Check for AWS ARNs with account IDs
          if grep -r -E "arn:aws:[a-z]+:[a-z0-9-]+:[0-9]{12}:" .github/workflows/ --exclude="verify-secrets.yml" --exclude="*.md"; then
            echo "âš ï¸  WARNING: Found hardcoded AWS ARNs with account IDs!"
          else
            echo "âœ… No hardcoded ARNs found"
          fi
          
          # Check for Alibaba Cloud ARNs
          if grep -r -E "acs:[a-z]+:[a-z0-9-]+:[0-9]+:analyzer" .github/workflows/ --exclude="verify-secrets.yml" --exclude="*.md"; then
            echo "âš ï¸  WARNING: Found hardcoded Alibaba ARNs!"
          else
            echo "âœ… No hardcoded Alibaba ARNs found"
          fi
      
      - name: Generate Secrets Report
        run: |
          echo ""
          echo "ðŸ“‹ Secrets Configuration Report"
          echo "=============================="
          echo ""
          echo "âœ… = Configured and available"
          echo "âŒ = Missing (required for core workflows)"
          echo "âš ï¸  = Missing (optional for some workflows)"
          echo ""
          echo "For detailed setup instructions, see SECURITY.md"
          echo ""
          echo "To configure secrets:"
          echo "1. Go to Settings â†’ Secrets and variables â†’ Actions"
          echo "2. Click 'New repository secret'"
          echo "3. Add each required secret from SECURITY.md"
      
      - name: Summary
        run: |
          echo "## ðŸ” Secrets Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š **Documentation:** See [SECURITY.md](./SECURITY.md) for complete setup guide." >> $GITHUB_STEP_SUMMARY
