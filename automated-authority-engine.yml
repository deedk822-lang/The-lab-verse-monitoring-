name: The Autonomous Authority and Impact Engine

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'The topic for the article to be generated by The Visionary'
        required: true
        default: 'The Future of AI in South African Finance'
      keyword:
        description: 'A keyword for the Tax Collector to search for (optional)'
        required: false

jobs:
  the_visionary:
    runs-on: ubuntu-latest
    name: "Run The Visionary (Content Generation)"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Generate Content and Post to WordPress
        env:
          LOCALAI_API_URL: ${{ secrets.LOCALAI_API_URL }}
          WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
          WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
        run: |
          # This is a conceptual representation of the script's execution.
          # In a real scenario, this would be a Python script.
          # For this example, we simulate the key steps.

          # 1. Generate Content using LocalAI
          REPORT_CONTENT=$(curl -sS "$LOCALAI_API_URL/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "command-r-plus",
              "messages": [{"role": "user", "content": "Write a 1000-word article on the topic: ${{ github.event.inputs.topic }}. Format as clean HTML."}]
            }' | jq -r .choices[0].message.content)

          # Check if content was generated
          if [ -z "$REPORT_CONTENT" ] || [ "$REPORT_CONTENT" == "null" ]; then
            echo "::error::Failed to generate content from LocalAI."
            exit 1
          fi

          # 2. Post to WordPress
          AUTH_HEADER=$(echo -n "$WORDPRESS_USER:$WORDPRESS_APP_PASSWORD" | base64)
          JSON_PAYLOAD=$(jq -n --arg title "${{ github.event.inputs.topic }}" --arg content "$REPORT_CONTENT" \
            '{title: $title, content: $content, status: "draft"}')

          curl -X POST "$WORDPRESS_URL/wp-json/wp/v2/posts" \
            -H "Authorization: Basic $AUTH_HEADER" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

  the_tax_collector:
    needs: [the_visionary]
    runs-on: ubuntu-latest
    name: "Run The Tax Collector (Conscience Check)"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Execute Tax Collector Script
        id: tax_collector_execution
        run: python scripts/tax_collector.py

      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tax-collector-report
          path: ./tax_collector_report.json

  the_arbiter:
    needs: [the_tax_collector]
    runs-on: ubuntu-latest
    name: "Run The Arbiter (Autonomous Optimization)"
    steps:
      - name: Placeholder for Arbiter Logic
        run: |
          echo "Future step: The Arbiter will download the tax_collector_report.json artifact."
          echo "It will also pull performance data from Grafana (dimakatsoMoleli.grafana.net)."
          echo "Using the Alibaba Self-Evolving Engine API, it will analyze this data to fine-tune the parameters of the other Judges."
          echo "This creates the autonomous feedback loop."

  gmail_monetization:
    needs: [the_visionary] # Run in parallel with the tax collector
    runs-on: ubuntu-latest
    name: "Run Gmail Monetization Workflow"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run Gmail Monetization Script
        env:
          CDATACONNECT_API_URL: ${{ secrets.CDATACONNECT_API_URL }}
          CDATACONNECT_API_KEY: ${{ secrets.CDATACONNECT_API_KEY }}
          LOCALAI_API_URL: ${{ secrets.LOCALAI_API_URL }}
          WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
          WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
        run: python scripts/gmail_monetization_workflow.py
